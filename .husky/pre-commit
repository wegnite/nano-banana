#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# è¿è¡Œæ—¶é”™è¯¯é¢„æ£€æœºåˆ¶
echo "ğŸ” Running pre-commit checks..."

# 1. TypeScriptç±»å‹æ£€æŸ¥
echo "ğŸ“ Checking TypeScript types..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript type check failed"
  exit 1
fi

# 2. ESLintæ£€æŸ¥
echo "ğŸ¨ Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ ESLint check failed"
  exit 1
fi

# 3. è¿è¡Œé›†æˆæµ‹è¯•
echo "ğŸ§ª Running integration tests..."
npm run test:integration 2>/dev/null
if [ $? -ne 0 ]; then
  echo "âš ï¸  Integration tests failed - please review"
  # ä¸é˜»æ­¢æäº¤ï¼Œä½†ç»™å‡ºè­¦å‘Š
fi

# 4. æ£€æŸ¥ç¯å¢ƒå˜é‡ä¸€è‡´æ€§
echo "ğŸ”§ Checking environment configuration..."
node -e "
const checkEnv = () => {
  const required = [
    'DATABASE_URL',
    'AUTH_SECRET',
    'NEXTAUTH_URL',
    'AUTH_URL',
    'NEXT_PUBLIC_WEB_URL'
  ];
  
  const missing = required.filter(key => !process.env[key]);
  if (missing.length > 0) {
    console.error('âŒ Missing environment variables:', missing.join(', '));
    process.exit(1);
  }
  
  // æ£€æŸ¥ç«¯å£ä¸€è‡´æ€§
  try {
    const nextAuthUrl = new URL(process.env.NEXTAUTH_URL);
    const authUrl = new URL(process.env.AUTH_URL);
    const webUrl = new URL(process.env.NEXT_PUBLIC_WEB_URL);
    
    if (nextAuthUrl.port !== authUrl.port || nextAuthUrl.port !== webUrl.port) {
      console.error('âŒ Port mismatch in URLs:');
      console.error('  NEXTAUTH_URL port:', nextAuthUrl.port);
      console.error('  AUTH_URL port:', authUrl.port);
      console.error('  WEB_URL port:', webUrl.port);
      process.exit(1);
    }
  } catch (e) {
    console.error('âŒ Invalid URL format in environment variables');
    process.exit(1);
  }
  
  console.log('âœ… Environment configuration is valid');
};

checkEnv();
"

if [ $? -ne 0 ]; then
  echo "âŒ Environment check failed"
  exit 1
fi

# 5. æ£€æŸ¥æ˜¯å¦æœ‰console.erroræœªå¤„ç†
echo "ğŸ” Checking for unhandled console.error..."
grep -r "console\.error" src/ --include="*.ts" --include="*.tsx" | grep -v "// TODO\|// FIXME\|catch" | head -5
if [ $? -eq 0 ]; then
  echo "âš ï¸  Found console.error statements - make sure they are properly handled"
fi

echo "âœ… All pre-commit checks passed!"