# ç”¨æˆ·å½’å› ç³»ç»Ÿéƒ¨ç½²æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åº”ç”¨æ•°æ®åº“è¿ç§»

```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶ï¼ˆå·²å®Œæˆï¼‰
npm run db:generate

# åº”ç”¨è¿ç§»åˆ°æ•°æ®åº“
npm run db:migrate
```

### 2. éªŒè¯ç¯å¢ƒå˜é‡

ç¡®ä¿ `.env` æ–‡ä»¶åŒ…å«å¿…è¦é…ç½®ï¼š

```env
# æ•°æ®åº“è¿æ¥
DATABASE_URL=your_database_url

# åº”ç”¨ç¯å¢ƒ
NODE_ENV=production
NEXT_PUBLIC_WEB_URL=https://yourdomain.com
```

### 3. é‡å¯åº”ç”¨

```bash
# å¼€å‘ç¯å¢ƒ
npm run dev

# ç”Ÿäº§ç¯å¢ƒ
npm run build
npm run start
```

## âœ… åŠŸèƒ½éªŒè¯æ¸…å•

### åŸºç¡€åŠŸèƒ½æµ‹è¯•

1. **CookieæŸ“è‰²æµ‹è¯•**
   - è®¿é—®ç½‘ç«™é¦–é¡µ
   - æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· > Application > Cookies
   - æŸ¥æ‰¾ `user_attribution` Cookie
   - éªŒè¯Cookieå†…å®¹ç»“æ„

2. **UTMå‚æ•°æµ‹è¯•**
   ```
   è®¿é—®: https://yourdomain.com?utm_source=google&utm_medium=cpc&utm_campaign=test
   ```
   - æ£€æŸ¥Cookieä¸­çš„sourceã€mediumã€campaignå­—æ®µ

3. **Referreræµ‹è¯•**
   - ä»Googleæœç´¢ç»“æœç‚¹å‡»è¿›å…¥
   - éªŒè¯sourceä¸º"google"ï¼Œmediumä¸º"organic"

4. **è®¾å¤‡è¯†åˆ«æµ‹è¯•**
   - ä½¿ç”¨ä¸åŒè®¾å¤‡è®¿é—®ï¼ˆPCã€æ‰‹æœºã€å¹³æ¿ï¼‰
   - éªŒè¯device_typeå­—æ®µæ­£ç¡®

## ğŸ“Š æ•°æ®åˆ†ææ¥å£

### è·å–å½’å› æ¦‚è§ˆ
```bash
GET /api/attribution/analytics?type=overview

# å“åº”ç¤ºä¾‹
{
  "total_users": 1250,
  "users_by_source": [
    {"source": "google", "count": 450},
    {"source": "facebook", "count": 320},
    {"source": "direct", "count": 280}
  ],
  "paid_users_by_source": [
    {"source": "google", "count": 85, "revenue": 12500},
    {"source": "facebook", "count": 45, "revenue": 6800}
  ]
}
```

### è·å–æ¸ é“åˆ†æ
```bash
GET /api/attribution/analytics?type=channels

# å“åº”ç¤ºä¾‹
{
  "channels": [
    {
      "source": "google",
      "medium": "cpc",
      "campaign": "summer2025",
      "users": 120,
      "orders": 15,
      "revenue": 2250,
      "conversion_rate": 12.5
    }
  ]
}
```

### è·å–è®¾å¤‡åˆ†æ
```bash
GET /api/attribution/analytics?type=devices

# å“åº”ç¤ºä¾‹
{
  "device_types": [
    {"device_type": "desktop", "users": 680, "revenue": 15600},
    {"device_type": "mobile", "users": 420, "revenue": 8900},
    {"device_type": "tablet", "users": 150, "revenue": 2100}
  ]
}
```

## ğŸ” æ•°æ®åº“æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥çœ‹ç”¨æˆ·å½’å› æ•°æ®
```sql
-- æŸ¥çœ‹æœ€è¿‘æ³¨å†Œç”¨æˆ·çš„æ¥æº
SELECT 
  email,
  attribution_source,
  attribution_medium,
  attribution_campaign,
  first_device_type,
  first_country,
  created_at
FROM users
WHERE attribution_source IS NOT NULL
ORDER BY created_at DESC
LIMIT 10;
```

### åˆ†æè½¬åŒ–ç‡
```sql
-- å„æ¸ é“çš„ä»˜è´¹è½¬åŒ–ç‡
SELECT 
  u.attribution_source,
  COUNT(DISTINCT u.uuid) as total_users,
  COUNT(DISTINCT o.user_uuid) as paid_users,
  ROUND(COUNT(DISTINCT o.user_uuid)::numeric / COUNT(DISTINCT u.uuid) * 100, 2) as conversion_rate
FROM users u
LEFT JOIN orders o ON u.uuid = o.user_uuid AND o.status = 'paid'
WHERE u.attribution_source IS NOT NULL
GROUP BY u.attribution_source
ORDER BY conversion_rate DESC;
```

### è®¾å¤‡ä»˜è´¹åˆ†æ
```sql
-- ä¸åŒè®¾å¤‡çš„è®¢å•æƒ…å†µ
SELECT 
  order_device_type,
  COUNT(*) as order_count,
  SUM(amount) as total_revenue,
  AVG(amount) as avg_order_value
FROM orders
WHERE status = 'paid' AND order_device_type IS NOT NULL
GROUP BY order_device_type;
```

## ğŸ¯ è¥é”€ä¼˜åŒ–å»ºè®®

### åŸºäºå½’å› æ•°æ®çš„å†³ç­–

1. **é¢„ç®—åˆ†é…**
   - æŸ¥çœ‹å„æ¸ é“ROIï¼šæ”¶å…¥/æˆæœ¬
   - ä¼˜å…ˆæŠ•æ”¾é«˜è½¬åŒ–æ¸ é“
   - å‡å°‘ä½æ•ˆæ¸ é“æŠ•å…¥

2. **è®¾å¤‡ä¼˜åŒ–**
   - åˆ†æä¸åŒè®¾å¤‡è½¬åŒ–ç‡
   - ä¼˜åŒ–ä½è½¬åŒ–è®¾å¤‡çš„ç”¨æˆ·ä½“éªŒ
   - é’ˆå¯¹ä¸»è¦è®¾å¤‡å¼€å‘åŠŸèƒ½

3. **åœ°åŸŸæ‰©å¼ **
   - è¯†åˆ«é«˜ä»·å€¼åœ°åŒº
   - æœ¬åœ°åŒ–é«˜è½¬åŒ–åœ°åŒº
   - å¼€æ‹“ç›¸ä¼¼å¸‚åœº

## ğŸ› æ•…éšœæ’é™¤

### Cookieæœªè®¾ç½®
- æ£€æŸ¥ä¸­é—´ä»¶æ˜¯å¦æ­£å¸¸è¿è¡Œ
- éªŒè¯Cookieè®¾ç½®çš„domainå’Œpath
- ç¡®è®¤HTTPSç¯å¢ƒä¸‹secureæ ‡è®°

### å½’å› æ•°æ®ä¸ºç©º
- ç¡®è®¤æ•°æ®åº“è¿ç§»å·²æ‰§è¡Œ
- æ£€æŸ¥ç”¨æˆ·æ³¨å†Œæµç¨‹
- éªŒè¯attributionæœåŠ¡å¯¼å…¥

### IPå®šä½å¤±è´¥
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- éªŒè¯IP-APIæœåŠ¡å¯ç”¨æ€§
- è€ƒè™‘ä½¿ç”¨å¤‡ç”¨æœåŠ¡

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ç´¢å¼•
```sql
-- æ·»åŠ ç´¢å¼•æå‡æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_users_attribution_source ON users(attribution_source);
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_orders_user_uuid ON orders(user_uuid);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_visitor_logs_visitor_id ON visitor_logs(visitor_id);
CREATE INDEX idx_visitor_logs_visited_at ON visitor_logs(visited_at);
```

### ç¼“å­˜ç­–ç•¥
- å½’å› åˆ†æç»“æœç¼“å­˜5åˆ†é’Ÿ
- IPåœ°ç†ä¿¡æ¯ç¼“å­˜1å°æ—¶
- é™æ€æŠ¥è¡¨æ¯æ—¥ç”Ÿæˆ

## ğŸ”’ éšç§åˆè§„

### GDPRåˆè§„
- Cookieä½¿ç”¨éœ€è¦ç”¨æˆ·åŒæ„
- æä¾›æ•°æ®åˆ é™¤åŠŸèƒ½
- è®°å½•ç”¨æˆ·åŒæ„æ—¥å¿—

### æ•°æ®å®‰å…¨
- IPåœ°å€è„±æ•å­˜å‚¨
- æ•æ„Ÿä¿¡æ¯åŠ å¯†
- å®šæœŸæ¸…ç†å†å²æ•°æ®

## ğŸ“š æ‰©å±•é˜…è¯»

- [UTMå‚æ•°æœ€ä½³å®è·µ](https://support.google.com/analytics/answer/1033863)
- [å½’å› æ¨¡å‹å¯¹æ¯”](https://support.google.com/analytics/answer/1662518)
- [Cookieæ”¿ç­–æŒ‡å—](https://gdpr.eu/cookies/)

## ğŸ‰ éƒ¨ç½²å®Œæˆæ£€æŸ¥

- [ ] æ•°æ®åº“è¿ç§»å·²æ‰§è¡Œ
- [ ] Cookieæ­£å¸¸è®¾ç½®
- [ ] UTMå‚æ•°æ­£ç¡®è§£æ
- [ ] Referrerè¯†åˆ«å‡†ç¡®
- [ ] è®¾å¤‡ç±»å‹åˆ¤æ–­æ­£ç¡®
- [ ] ç”¨æˆ·æ³¨å†Œè®°å½•å½’å› 
- [ ] è®¢å•åˆ›å»ºè®°å½•å½’å› 
- [ ] åˆ†æAPIå¯è®¿é—®
- [ ] æ•°æ®å±•ç¤ºæ­£å¸¸

---

**æ­å–œï¼ç”¨æˆ·å½’å› ç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²ã€‚**

ç°åœ¨æ‚¨å¯ä»¥ï¼š
1. ç²¾å‡†è¿½è¸ªç”¨æˆ·æ¥æº
2. åˆ†æå„æ¸ é“è½¬åŒ–ç‡
3. ä¼˜åŒ–è¥é”€æŠ•æ”¾ç­–ç•¥
4. æå‡ROIå’Œç”¨æˆ·ä»·å€¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚