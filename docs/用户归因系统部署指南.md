# 用户归因系统部署指南

## 🚀 快速开始

### 1. 应用数据库迁移

```bash
# 生成迁移文件（已完成）
npm run db:generate

# 应用迁移到数据库
npm run db:migrate
```

### 2. 验证环境变量

确保 `.env` 文件包含必要配置：

```env
# 数据库连接
DATABASE_URL=your_database_url

# 应用环境
NODE_ENV=production
NEXT_PUBLIC_WEB_URL=https://{{PRODUCTION_DOMAIN}}
```

### 3. 重启应用

```bash
# 开发环境
npm run dev

# 生产环境
npm run build
npm run start
```

## ✅ 功能验证清单

### 基础功能测试

1. **Cookie染色测试**
   - 访问网站首页
   - 打开浏览器开发者工具 > Application > Cookies
   - 查找 `user_attribution` Cookie
   - 验证Cookie内容结构

2. **UTM参数测试**
   ```
   访问: https://{{PRODUCTION_DOMAIN}}?utm_source=google&utm_medium=cpc&utm_campaign=test
   ```
   - 检查Cookie中的source、medium、campaign字段

3. **Referrer测试**
   - 从Google搜索结果点击进入
   - 验证source为"google"，medium为"organic"

4. **设备识别测试**
   - 使用不同设备访问（PC、手机、平板）
   - 验证device_type字段正确

## 📊 数据分析接口

### 获取归因概览
```bash
GET /api/attribution/analytics?type=overview

# 响应示例
{
  "total_users": 1250,
  "users_by_source": [
    {"source": "google", "count": 450},
    {"source": "facebook", "count": 320},
    {"source": "direct", "count": 280}
  ],
  "paid_users_by_source": [
    {"source": "google", "count": 85, "revenue": 12500},
    {"source": "facebook", "count": 45, "revenue": 6800}
  ]
}
```

### 获取渠道分析
```bash
GET /api/attribution/analytics?type=channels

# 响应示例
{
  "channels": [
    {
      "source": "google",
      "medium": "cpc",
      "campaign": "summer2025",
      "users": 120,
      "orders": 15,
      "revenue": 2250,
      "conversion_rate": 12.5
    }
  ]
}
```

### 获取设备分析
```bash
GET /api/attribution/analytics?type=devices

# 响应示例
{
  "device_types": [
    {"device_type": "desktop", "users": 680, "revenue": 15600},
    {"device_type": "mobile", "users": 420, "revenue": 8900},
    {"device_type": "tablet", "users": 150, "revenue": 2100}
  ]
}
```

## 🔍 数据库查询示例

### 查看用户归因数据
```sql
-- 查看最近注册用户的来源
SELECT 
  email,
  attribution_source,
  attribution_medium,
  attribution_campaign,
  first_device_type,
  first_country,
  created_at
FROM users
WHERE attribution_source IS NOT NULL
ORDER BY created_at DESC
LIMIT 10;
```

### 分析转化率
```sql
-- 各渠道的付费转化率
SELECT 
  u.attribution_source,
  COUNT(DISTINCT u.uuid) as total_users,
  COUNT(DISTINCT o.user_uuid) as paid_users,
  ROUND(COUNT(DISTINCT o.user_uuid)::numeric / COUNT(DISTINCT u.uuid) * 100, 2) as conversion_rate
FROM users u
LEFT JOIN orders o ON u.uuid = o.user_uuid AND o.status = 'paid'
WHERE u.attribution_source IS NOT NULL
GROUP BY u.attribution_source
ORDER BY conversion_rate DESC;
```

### 设备付费分析
```sql
-- 不同设备的订单情况
SELECT 
  order_device_type,
  COUNT(*) as order_count,
  SUM(amount) as total_revenue,
  AVG(amount) as avg_order_value
FROM orders
WHERE status = 'paid' AND order_device_type IS NOT NULL
GROUP BY order_device_type;
```

## 🎯 营销优化建议

### 基于归因数据的决策

1. **预算分配**
   - 查看各渠道ROI：收入/成本
   - 优先投放高转化渠道
   - 减少低效渠道投入

2. **设备优化**
   - 分析不同设备转化率
   - 优化低转化设备的用户体验
   - 针对主要设备开发功能

3. **地域扩张**
   - 识别高价值地区
   - 本地化高转化地区
   - 开拓相似市场

## 🐛 故障排除

### Cookie未设置
- 检查中间件是否正常运行
- 验证Cookie设置的domain和path
- 确认HTTPS环境下secure标记

### 归因数据为空
- 确认数据库迁移已执行
- 检查用户注册流程
- 验证attribution服务导入

### IP定位失败
- 检查网络连接
- 验证IP-API服务可用性
- 考虑使用备用服务

## 📈 性能优化

### 数据库索引
```sql
-- 添加索引提升查询性能
CREATE INDEX idx_users_attribution_source ON users(attribution_source);
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_orders_user_uuid ON orders(user_uuid);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_visitor_logs_visitor_id ON visitor_logs(visitor_id);
CREATE INDEX idx_visitor_logs_visited_at ON visitor_logs(visited_at);
```

### 缓存策略
- 归因分析结果缓存5分钟
- IP地理信息缓存1小时
- 静态报表每日生成

## 🔒 隐私合规

### GDPR合规
- Cookie使用需要用户同意
- 提供数据删除功能
- 记录用户同意日志

### 数据安全
- IP地址脱敏存储
- 敏感信息加密
- 定期清理历史数据

## 📚 扩展阅读

- [UTM参数最佳实践](https://support.google.com/analytics/answer/1033863)
- [归因模型对比](https://support.google.com/analytics/answer/1662518)
- [Cookie政策指南](https://gdpr.eu/cookies/)

## 🎉 部署完成检查

- [ ] 数据库迁移已执行
- [ ] Cookie正常设置
- [ ] UTM参数正确解析
- [ ] Referrer识别准确
- [ ] 设备类型判断正确
- [ ] 用户注册记录归因
- [ ] 订单创建记录归因
- [ ] 分析API可访问
- [ ] 数据展示正常

---

**恭喜！用户归因系统已成功部署。**

现在您可以：
1. 精准追踪用户来源
2. 分析各渠道转化率
3. 优化营销投放策略
4. 提升ROI和用户价值

如有问题，请查看项目文档或联系技术支持。