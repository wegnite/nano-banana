# 📚 AI Universal Generator 项目代码规范

> 版本：1.0.0  
> 更新日期：2025-08-20  
> 适用范围：所有前端和后端代码

## 📋 目录

1. [核心原则](#核心原则)
2. [TypeScript 规范](#typescript-规范)
3. [React/Next.js 规范](#reactnextjs-规范)
4. [样式规范](#样式规范)
5. [API 规范](#api-规范)
6. [安全规范](#安全规范)
7. [性能规范](#性能规范)
8. [Git 规范](#git-规范)
9. [测试规范](#测试规范)
10. [文档规范](#文档规范)

---

## 🎯 核心原则

### 1. 代码质量优先
- **可读性** > 简洁性
- **可维护性** > 性能（除非性能是关键需求）
- **类型安全** > 灵活性

### 2. 一致性原则
- 遵循既定模式，不要混用多种风格
- 新代码应与现有代码风格保持一致
- 使用自动化工具确保一致性

### 3. 简单原则
- 优先使用简单、直接的解决方案
- 避免过度设计
- 代码应该易于理解和修改

---

## 🔷 TypeScript 规范

### 类型定义

#### ✅ 正确示例
```typescript
// 使用 interface 定义对象类型
interface User {
  id: string;
  email: string;
  name?: string; // 可选属性
  role: 'admin' | 'user'; // 字面量类型
  createdAt: Date;
}

// 使用 type 定义联合类型
type Status = 'pending' | 'processing' | 'completed' | 'failed';

// 使用泛型提高复用性
interface ApiResponse<T> {
  data: T;
  error?: string;
  status: number;
}
```

#### ❌ 错误示例
```typescript
// 避免使用 any
const handleData = (data: any) => { }; // ❌

// 避免使用 object
const user: object = { }; // ❌

// 避免类型断言滥用
const value = someValue as string; // ❌ 除非必要
```

### 函数规范

```typescript
// ✅ 明确的参数和返回类型
async function fetchUser(userId: string): Promise<User | null> {
  try {
    const response = await fetch(`/api/users/${userId}`);
    if (!response.ok) return null;
    return await response.json();
  } catch (error) {
    console.error('Failed to fetch user:', error);
    return null;
  }
}

// ✅ 使用函数重载处理多态
function formatValue(value: string): string;
function formatValue(value: number): string;
function formatValue(value: string | number): string {
  return String(value);
}
```

### 枚举和常量

```typescript
// ✅ 使用 const assertion
const API_ENDPOINTS = {
  USER: '/api/user',
  POSTS: '/api/posts',
  COMMENTS: '/api/comments',
} as const;

// ✅ 使用枚举管理相关常量
enum CreditsAmount {
  TEXT_GENERATION = 1,
  IMAGE_GENERATION = 5,
  VIDEO_GENERATION = 10,
}
```

---

## ⚛️ React/Next.js 规范

### 组件定义

#### 函数组件（推荐）
```typescript
// ✅ 正确的函数组件定义
interface ButtonProps {
  children: React.ReactNode;
  onClick?: () => void;
  variant?: 'primary' | 'secondary';
  disabled?: boolean;
}

const Button: React.FC<ButtonProps> = ({ 
  children, 
  onClick, 
  variant = 'primary',
  disabled = false 
}) => {
  return (
    <button
      className={`btn btn-${variant}`}
      onClick={onClick}
      disabled={disabled}
    >
      {children}
    </button>
  );
};

Button.displayName = 'Button'; // 必须添加 displayName
export default Button;
```

### Hooks 使用规范

#### ✅ 正确使用 Hooks
```typescript
const MyComponent: React.FC = () => {
  // 1. Hooks 必须在组件顶层调用
  const [count, setCount] = useState(0);
  const router = useRouter();
  
  // 2. 使用 useMemo 缓存计算结果
  const expensiveValue = useMemo(() => {
    return computeExpensiveValue(count);
  }, [count]);
  
  // 3. 使用 useCallback 缓存函数
  const handleClick = useCallback(() => {
    setCount(prev => prev + 1);
  }, []);
  
  // 4. useEffect 完整的依赖数组
  useEffect(() => {
    const timer = setTimeout(() => {
      console.log('Count:', count);
    }, 1000);
    
    return () => clearTimeout(timer); // 清理函数
  }, [count]); // 明确依赖
  
  // ❌ 错误：条件调用 Hooks
  if (someCondition) {
    useState(0); // ❌ 永远不要这样做
  }
  
  return <div>{/* ... */}</div>;
};
```

### 自定义 Hooks

```typescript
// ✅ 自定义 Hook 命名以 use 开头
function useDebounce<T>(value: T, delay: number): T {
  const [debouncedValue, setDebouncedValue] = useState(value);
  
  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);
    
    return () => clearTimeout(handler);
  }, [value, delay]);
  
  return debouncedValue;
}
```

### 性能优化

```typescript
// ✅ 使用 React.memo 优化组件
const ExpensiveComponent = React.memo(({ data }: Props) => {
  return <div>{/* 复杂渲染逻辑 */}</div>;
}, (prevProps, nextProps) => {
  // 自定义比较函数（可选）
  return prevProps.data.id === nextProps.data.id;
});

// ✅ 懒加载组件
const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
  loading: () => <Skeleton />,
  ssr: false, // 禁用 SSR（如需要）
});
```

### Next.js 特定规范

#### 页面组件
```typescript
// app/[locale]/(default)/page.tsx
import { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Page Title',
  description: 'Page description',
};

// ✅ 异步服务器组件
async function HomePage({ params }: { params: { locale: string } }) {
  const data = await fetchData(); // 服务器端数据获取
  
  return (
    <div>
      {/* 页面内容 */}
    </div>
  );
}

HomePage.displayName = 'HomePage';
export default HomePage;
```

#### 图片优化
```typescript
// ✅ 使用 next/image
import Image from 'next/image';

<Image
  src="/logo.png"
  alt="Company Logo" // 必须有 alt
  width={200}
  height={50}
  priority // 首屏图片
  placeholder="blur" // 加载占位
  blurDataURL="..." // base64 模糊图
/>

// ❌ 避免使用原生 img
<img src="/logo.png" /> // ❌
```

---

## 🎨 样式规范

### Tailwind CSS 使用

```typescript
// ✅ 组织好的类名
<div className={cn(
  // 布局
  "flex flex-col gap-4",
  // 间距
  "p-6 mx-auto",
  // 样式
  "bg-white dark:bg-gray-900",
  "rounded-lg shadow-md",
  // 响应式
  "w-full md:w-1/2 lg:w-1/3",
  // 条件样式
  isActive && "border-2 border-primary",
  disabled && "opacity-50 cursor-not-allowed"
)} />

// ❌ 避免过长的内联类名
<div className="flex flex-col gap-4 p-6 mx-auto bg-white dark:bg-gray-900 rounded-lg shadow-md w-full md:w-1/2 lg:w-1/3 border-2 border-primary opacity-50 cursor-not-allowed" /> // ❌
```

### CSS Modules（如使用）

```scss
// styles.module.scss
.container {
  @apply flex flex-col gap-4;
  
  &.active {
    @apply border-2 border-primary;
  }
  
  // 自定义样式
  .custom {
    background: linear-gradient(to right, #667eea, #764ba2);
  }
}
```

---

## 🔌 API 规范

### RESTful API 设计

```typescript
// ✅ 统一的 API 路由结构
// app/api/users/route.ts - 用户列表
export async function GET(request: Request) {
  const users = await getUsers();
  return Response.json(users);
}

export async function POST(request: Request) {
  const data = await request.json();
  const user = await createUser(data);
  return Response.json(user, { status: 201 });
}

// app/api/users/[id]/route.ts - 单个用户
export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  const user = await getUser(params.id);
  if (!user) {
    return Response.json({ error: 'User not found' }, { status: 404 });
  }
  return Response.json(user);
}
```

### 错误处理

```typescript
// ✅ 统一的错误响应格式
interface ApiError {
  error: string;
  code?: string;
  details?: any;
}

export function respErr(message: string, status = 400): Response {
  return Response.json(
    { error: message } as ApiError,
    { status }
  );
}

export function respData<T>(data: T, status = 200): Response {
  return Response.json(data, { status });
}

// 使用示例
export async function POST(request: Request) {
  try {
    // 输入验证
    const body = await request.json();
    const validation = validateInput(body);
    if (!validation.success) {
      return respErr(validation.error, 400);
    }
    
    // 业务逻辑
    const result = await processRequest(body);
    return respData(result);
    
  } catch (error) {
    console.error('API Error:', error);
    return respErr('Internal server error', 500);
  }
}
```

### 输入验证

```typescript
// ✅ 使用 Zod 进行验证
import { z } from 'zod';

const CreateUserSchema = z.object({
  email: z.string().email(),
  name: z.string().min(2).max(50),
  password: z.string().min(8).regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/),
  role: z.enum(['admin', 'user']).optional(),
});

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const data = CreateUserSchema.parse(body); // 自动验证和类型推断
    
    const user = await createUser(data);
    return respData(user, 201);
    
  } catch (error) {
    if (error instanceof z.ZodError) {
      return respErr(error.errors[0].message, 400);
    }
    return respErr('Server error', 500);
  }
}
```

---

## 🔐 安全规范

### 环境变量管理

```typescript
// ✅ 正确的环境变量使用
// 客户端可见（以 NEXT_PUBLIC_ 开头）
const apiUrl = process.env.NEXT_PUBLIC_API_URL;

// 服务器端私密变量（不要暴露给客户端）
const secretKey = process.env.SECRET_KEY; // 仅在服务器端使用

// ❌ 错误：暴露敏感信息
console.log('API Key:', process.env.OPENAI_API_KEY); // ❌
```

### 用户输入处理

```typescript
// ✅ 永远验证和清理用户输入
import DOMPurify from 'isomorphic-dompurify';

function sanitizeInput(input: string): string {
  // 清理 HTML
  const cleaned = DOMPurify.sanitize(input, { 
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong'] 
  });
  
  // 防止 SQL 注入（使用参数化查询）
  // 防止 XSS（使用适当的编码）
  return cleaned;
}
```

### 认证和授权

```typescript
// ✅ 在 API 路由中检查认证
import { auth } from '@/auth';

export async function POST(request: Request) {
  // 检查用户认证
  const session = await auth();
  if (!session?.user) {
    return respErr('Unauthorized', 401);
  }
  
  // 检查用户权限
  if (session.user.role !== 'admin') {
    return respErr('Forbidden', 403);
  }
  
  // 处理请求...
}
```

### CORS 配置

```typescript
// ✅ 严格的 CORS 配置
const allowedOrigins = [
  process.env.NEXT_PUBLIC_WEB_URL,
  'https://{{PRODUCTION_DOMAIN}}',
];

export async function OPTIONS(request: Request) {
  const origin = request.headers.get('origin');
  
  return new Response(null, {
    status: 204,
    headers: {
      'Access-Control-Allow-Origin': 
        allowedOrigins.includes(origin || '') ? origin! : '',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
      'Access-Control-Max-Age': '86400',
    },
  });
}
```

---

## ⚡ 性能规范

### 代码分割

```typescript
// ✅ 动态导入大型组件
const HeavyChart = dynamic(() => import('./HeavyChart'), {
  loading: () => <ChartSkeleton />,
  ssr: false,
});

// ✅ 条件加载
const AdminPanel = dynamic(() => 
  user?.role === 'admin' 
    ? import('./AdminPanel')
    : Promise.resolve(() => null)
);
```

### 数据获取优化

```typescript
// ✅ 并行数据获取
const [users, posts, comments] = await Promise.all([
  fetchUsers(),
  fetchPosts(),
  fetchComments(),
]);

// ✅ 使用 React Query 或 SWR 缓存
import useSWR from 'swr';

function useUser(id: string) {
  const { data, error, isLoading } = useSWR(
    `/api/users/${id}`,
    fetcher,
    {
      revalidateOnFocus: false,
      revalidateOnReconnect: false,
      dedupingInterval: 60000, // 1分钟内不重复请求
    }
  );
  
  return { user: data, error, isLoading };
}
```

### 防抖和节流

```typescript
// ✅ 搜索输入防抖
const SearchInput: React.FC = () => {
  const [query, setQuery] = useState('');
  const debouncedQuery = useDebounce(query, 300);
  
  useEffect(() => {
    if (debouncedQuery) {
      searchAPI(debouncedQuery);
    }
  }, [debouncedQuery]);
  
  return (
    <input
      value={query}
      onChange={(e) => setQuery(e.target.value)}
      placeholder="Search..."
    />
  );
};

// ✅ 滚动事件节流
const handleScroll = useThrottle(() => {
  // 处理滚动逻辑
}, 100);
```

---

## 📝 Git 规范

### 分支命名

```bash
# 功能分支
feature/user-authentication
feature/payment-integration

# 修复分支
fix/login-error
fix/memory-leak

# 热修复
hotfix/critical-security-issue

# 发布分支
release/v1.2.0
```

### Commit 消息格式

```bash
# 格式：<type>(<scope>): <subject>

# 示例
feat(auth): add Google OAuth login
fix(api): resolve rate limiting issue
docs(readme): update installation guide
style(components): format code with prettier
refactor(utils): simplify error handling
test(api): add user endpoint tests
chore(deps): update dependencies
```

### Commit 类型

- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式化
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建/工具相关

---

## 🧪 测试规范

### 单元测试

```typescript
// ✅ 测试文件命名：*.test.ts 或 *.spec.ts
// utils/validation.test.ts
import { validateEmail, validatePassword } from './validation';

describe('Validation Utils', () => {
  describe('validateEmail', () => {
    it('should accept valid email', () => {
      expect(validateEmail('user@example.com')).toBe(true);
    });
    
    it('should reject invalid email', () => {
      expect(validateEmail('invalid')).toBe(false);
    });
  });
  
  describe('validatePassword', () => {
    it('should require minimum 8 characters', () => {
      expect(validatePassword('1234567')).toBe(false);
      expect(validatePassword('12345678')).toBe(true);
    });
  });
});
```

### 组件测试

```typescript
// ✅ React 组件测试
import { render, screen, fireEvent } from '@testing-library/react';
import Button from './Button';

describe('Button Component', () => {
  it('should render with children', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByText('Click me')).toBeInTheDocument();
  });
  
  it('should call onClick when clicked', () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick}>Click</Button>);
    
    fireEvent.click(screen.getByRole('button'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });
  
  it('should be disabled when disabled prop is true', () => {
    render(<Button disabled>Disabled</Button>);
    expect(screen.getByRole('button')).toBeDisabled();
  });
});
```

---

## 📚 文档规范

### 代码注释

```typescript
/**
 * 计算用户的信用分数
 * 
 * @param user - 用户对象
 * @param transactions - 用户的交易历史
 * @returns 信用分数（0-100）
 * 
 * @example
 * ```typescript
 * const score = calculateCreditScore(user, transactions);
 * console.log(`Credit score: ${score}`);
 * ```
 */
export function calculateCreditScore(
  user: User,
  transactions: Transaction[]
): number {
  // 实现逻辑...
}
```

### README 结构

```markdown
# 项目名称

简短的项目描述

## 特性
- 特性 1
- 特性 2

## 快速开始

### 环境要求
- Node.js >= 18
- PostgreSQL >= 14

### 安装
\`\`\`bash
npm install
\`\`\`

### 配置
1. 复制 `.env.example` 到 `.env`
2. 配置环境变量

### 运行
\`\`\`bash
npm run dev
\`\`\`

## API 文档
[链接到 API 文档]

## 贡献指南
[链接到贡献指南]

## 许可证
MIT
```

---

## 🛠️ 工具配置

### ESLint 配置（.eslintrc.json）

```json
{
  "extends": [
    "next/core-web-vitals",
    "plugin:@typescript-eslint/recommended"
  ],
  "rules": {
    "@typescript-eslint/no-explicit-any": "error",
    "@typescript-eslint/no-unused-vars": "error",
    "react/display-name": "error",
    "react-hooks/rules-of-hooks": "error",
    "react-hooks/exhaustive-deps": "warn"
  }
}
```

### Prettier 配置（.prettierrc）

```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": false,
  "printWidth": 80,
  "tabWidth": 2,
  "useTabs": false,
  "bracketSpacing": true,
  "arrowParens": "always"
}
```

### TypeScript 配置（tsconfig.json）

```json
{
  "compilerOptions": {
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  }
}
```

---

## 📋 代码审查清单

### 提交前检查

- [ ] 代码通过 TypeScript 编译（`npx tsc --noEmit`）
- [ ] 代码通过 ESLint 检查（`npm run lint`）
- [ ] 代码已格式化（`npm run format`）
- [ ] 所有测试通过（`npm test`）
- [ ] 没有 console.log 或调试代码
- [ ] 没有注释掉的代码
- [ ] 组件有 displayName
- [ ] 图片使用 next/image
- [ ] API 有错误处理
- [ ] 敏感信息未暴露

### 代码审查要点

1. **功能性**：代码是否实现了预期功能？
2. **可读性**：代码是否易于理解？
3. **性能**：是否有明显的性能问题？
4. **安全性**：是否有安全漏洞？
5. **测试**：是否有适当的测试覆盖？
6. **文档**：是否更新了相关文档？

---

## 🚀 持续改进

这份规范是活文档，应该随着项目发展不断更新：

1. **定期审查**：每季度审查一次规范
2. **团队反馈**：收集团队成员的改进建议
3. **工具更新**：关注新工具和最佳实践
4. **自动化**：尽可能自动化规范检查

---

**最后更新**: 2025-08-20  
**维护者**: AI Universal Generator Team  
**版本**: 1.0.0