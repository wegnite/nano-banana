# æ•°æ®åº“è¿ç§»ä¸å®‰å…¨é…ç½®æŒ‡å—

## ğŸ“š ç›®å½•
1. [æ•°æ®åº“è¿ç§»æµç¨‹](#æ•°æ®åº“è¿ç§»æµç¨‹)
2. [Supabase å®‰å…¨é…ç½®](#supabase-å®‰å…¨é…ç½®)
3. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
4. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ•°æ®åº“è¿ç§»æµç¨‹

### é—®é¢˜å‘ç°
åœ¨å®æ–½è®¢é˜…ç³»ç»Ÿæ—¶ï¼Œå‘ç°è™½ç„¶å·²é…ç½® `DATABASE_URL`ï¼Œä½†æ–°åˆ›å»ºçš„è®¢é˜…è¡¨è¿˜æ²¡æœ‰åŒæ­¥åˆ° Supabase æ•°æ®åº“ã€‚

### è§£å†³æ­¥éª¤

#### 1. æ·»åŠ è¡¨ç»“æ„åˆ°ä¸» Schema
```typescript
// src/db/schema.ts
export const subscriptions = pgTable("subscriptions", {
  id: integer().primaryKey().generatedAlwaysAsIdentity(),
  user_uuid: varchar({ length: 255 }).notNull().unique(),
  // ... å…¶ä»–å­—æ®µ
});
```

#### 2. ç”Ÿæˆè¿ç§»æ–‡ä»¶
```bash
npm run db:generate
```
è¿™ä¼šåœ¨ `src/db/migrations/` ç›®å½•ä¸‹ç”Ÿæˆæ–°çš„ SQL è¿ç§»æ–‡ä»¶ã€‚

#### 3. æ‰§è¡Œè¿ç§»
```bash
npm run db:migrate
```
å°†è¿ç§»åº”ç”¨åˆ° Supabase æ•°æ®åº“ã€‚

#### 4. éªŒè¯è¡¨åˆ›å»º
```javascript
// test/check-tables.js
const tables = ['subscriptions', 'subscription_plans', 'subscription_usage'];
// éªŒè¯æ¯ä¸ªè¡¨æ˜¯å¦å­˜åœ¨
```

### å…³é”®å‘ç°
- **Drizzle ORM è¿ç§»ç³»ç»Ÿ**ï¼šè‡ªåŠ¨è·Ÿè¸ªå·²åº”ç”¨çš„è¿ç§»ï¼Œé¿å…é‡å¤æ‰§è¡Œ
- **è¿ç§»æ–‡ä»¶å‘½å**ï¼šè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„è¿ç§»æ–‡ä»¶åï¼ˆå¦‚ `0001_crazy_princess_powerful.sql`ï¼‰
- **ç¯å¢ƒå˜é‡åŠ è½½**ï¼šéœ€è¦æ­£ç¡®åŠ è½½ `.env.local` æ–‡ä»¶æ‰èƒ½è¯»å– `DATABASE_URL`

---

## Supabase å®‰å…¨é…ç½®

### âš ï¸ é‡è¦å®‰å…¨é—®é¢˜ï¼šUnrestricted è¡¨

#### é—®é¢˜æè¿°
åœ¨ Supabase Table Editor ä¸­ï¼Œæ‰€æœ‰è¡¨éƒ½æ˜¾ç¤º "Unrestricted" æ ‡è®°ï¼Œè¿™æ„å‘³ç€ï¼š

1. **RLSï¼ˆRow Level Securityï¼‰æœªå¯ç”¨**
   - æ•°æ®å¯ä»¥è¢«å…¬å¼€è®¿é—®
   - ä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡ API è¯»å–/ä¿®æ”¹æ•°æ®
   - è¿™æ˜¯ä¸¥é‡çš„å®‰å…¨éšæ‚£

2. **æ˜¾ç¤ºçš„è­¦å‘Šä¿¡æ¯**
   ```
   Data is publicly accessible via API as RLS is disabled. Learn more.
   ```

#### ç«‹å³ä¿®å¤æ–¹æ¡ˆ

##### 1. å¯ç”¨ RLSï¼ˆè¡Œçº§å®‰å…¨ï¼‰
```sql
-- ä¸ºæ¯ä¸ªè¡¨å¯ç”¨ RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE credits ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscription_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscription_usage ENABLE ROW LEVEL SECURITY;
```

##### 2. åˆ›å»ºè®¿é—®ç­–ç•¥
```sql
-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ®
CREATE POLICY "Users can view own data" ON users
  FOR SELECT USING (auth.uid()::text = user_uuid);

-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç§¯åˆ†
CREATE POLICY "Users can view own credits" ON credits
  FOR SELECT USING (auth.uid()::text = user_uuid);

-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢é˜…
CREATE POLICY "Users can view own subscription" ON subscriptions
  FOR SELECT USING (auth.uid()::text = user_uuid);

-- è®¢é˜…è®¡åˆ’æ‰€æœ‰äººå¯æŸ¥çœ‹ï¼ˆå…¬å¼€ä¿¡æ¯ï¼‰
CREATE POLICY "Anyone can view subscription plans" ON subscription_plans
  FOR SELECT USING (true);
```

##### 3. æœåŠ¡ç«¯è®¿é—®ï¼ˆç»•è¿‡ RLSï¼‰
```javascript
// ä½¿ç”¨ service_role keyï¼ˆä»…åœ¨æœåŠ¡ç«¯ï¼‰
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY // ä¸æ˜¯ anon key
)
```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1ï¼šDATABASE_URL æœªé…ç½®
**ç—‡çŠ¶**ï¼šè¿è¡Œè„šæœ¬æ—¶æŠ¥é”™ "DATABASE_URL æœªé…ç½®"

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// ç¡®ä¿åŠ è½½ .env.local
require('dotenv').config();
require('dotenv').config({ path: '.env.local' });
```

### é—®é¢˜ 2ï¼šè¿ç§»æ–‡ä»¶æœªç”Ÿæˆ
**ç—‡çŠ¶**ï¼šä¿®æ”¹ schema åè¿è¡Œ `db:generate` æ²¡æœ‰ç”Ÿæˆæ–°æ–‡ä»¶

**åŸå› **ï¼šDrizzle è®¤ä¸ºæ²¡æœ‰å®è´¨æ€§æ”¹å˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ schema æ–‡ä»¶è¯­æ³•
2. ç¡®ä¿æœ‰å®é™…çš„è¡¨ç»“æ„å˜åŒ–
3. å¿…è¦æ—¶æ‰‹åŠ¨åˆ›å»ºè¿ç§»æ–‡ä»¶

### é—®é¢˜ 3ï¼šè¿ç§»æ‰§è¡Œå¤±è´¥
**ç—‡çŠ¶**ï¼š`db:migrate` æŠ¥é”™

**å¯èƒ½åŸå› **ï¼š
- æ•°æ®åº“è¿æ¥é—®é¢˜
- è¡¨å·²å­˜åœ¨
- å¤–é”®çº¦æŸå†²çª

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
2. æŸ¥çœ‹ Supabase æ—¥å¿—
3. å¿…è¦æ—¶æ‰‹åŠ¨æ‰§è¡Œ SQL

---

## æœ€ä½³å®è·µ

### 1. æ•°æ®åº“æ¶æ„è®¾è®¡
- **ä½¿ç”¨äº‹åŠ¡**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **æ·»åŠ ç´¢å¼•**ï¼šä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- **è®¾ç½®é»˜è®¤å€¼**ï¼šé¿å…ç©ºå€¼é—®é¢˜

### 2. å®‰å…¨é…ç½®
- **å§‹ç»ˆå¯ç”¨ RLS**ï¼šé˜²æ­¢æ•°æ®æ³„éœ²
- **æœ€å°æƒé™åŸåˆ™**ï¼šåªæˆäºˆå¿…è¦çš„æƒé™
- **å®šæœŸå®¡æŸ¥ç­–ç•¥**ï¼šç¡®ä¿å®‰å…¨ç­–ç•¥æœ‰æ•ˆ

### 3. è¿ç§»ç®¡ç†
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šå°†è¿ç§»æ–‡ä»¶çº³å…¥ Git
- **æµ‹è¯•ç¯å¢ƒå…ˆè¡Œ**ï¼šå…ˆåœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•
- **å¤‡ä»½é‡è¦æ•°æ®**ï¼šæ‰§è¡Œè¿ç§»å‰å¤‡ä»½

### 4. ç¯å¢ƒå˜é‡ç®¡ç†
```bash
# .env.local (å¼€å‘ç¯å¢ƒ)
DATABASE_URL="postgresql://..."
SUPABASE_URL="https://xxx.supabase.co"
SUPABASE_ANON_KEY="xxx"  # å®¢æˆ·ç«¯ä½¿ç”¨
SUPABASE_SERVICE_ROLE_KEY="xxx"  # æœåŠ¡ç«¯ä½¿ç”¨ï¼ˆç»•è¿‡ RLSï¼‰
```

### 5. ç›‘æ§ä¸æ—¥å¿—
- ä½¿ç”¨ Supabase Dashboard ç›‘æ§æŸ¥è¯¢
- è®°å½•å…³é”®æ“ä½œæ—¥å¿—
- è®¾ç½®é”™è¯¯å‘Šè­¦

---

## è®¢é˜…ç³»ç»Ÿé›†æˆæ€»ç»“

### å·²å®Œæˆå·¥ä½œ
1. âœ… è®¾è®¡ä¸‰è¡¨ç»“æ„ï¼ˆsubscriptionsã€subscription_plansã€subscription_usageï¼‰
2. âœ… åˆ›å»ºæœåŠ¡å±‚ï¼ˆ`src/services/subscription.ts`ï¼‰
3. âœ… æ›´æ–° API è·¯ç”±æ”¯æŒæ··åˆè®¡è´¹
4. âœ… ç”Ÿæˆå¹¶æ‰§è¡Œæ•°æ®åº“è¿ç§»
5. âœ… éªŒè¯è¡¨åˆ›å»ºæˆåŠŸ

### å¾…å®Œæˆå·¥ä½œ
1. âš ï¸ **å¯ç”¨ RLS ä¿æŠ¤æ•°æ®å®‰å…¨**ï¼ˆç´§æ€¥ï¼‰
2. ğŸ“ æ’å…¥é»˜è®¤è®¢é˜…è®¡åˆ’æ•°æ®
3. ğŸ’³ é›†æˆ Stripe æ”¯ä»˜
4. ğŸ¨ åˆ›å»ºè®¢é˜…ç®¡ç†ç•Œé¢
5. ğŸ“Š æ·»åŠ ä½¿ç”¨é‡åˆ†æ

### ç³»ç»Ÿæ¶æ„
```
ç”¨æˆ·è¯·æ±‚ â†’ API è·¯ç”± â†’ æƒé™æ£€æŸ¥
                â†“
         [è®¢é˜…ç”¨æˆ·ï¼Ÿ]
         â†™        â†˜
      æ˜¯            å¦
       â†“            â†“
  è®°å½•ä½¿ç”¨é‡    æ£€æŸ¥ç§¯åˆ†
       â†“            â†“
   ä¸æ‰£ç§¯åˆ†      æ‰£é™¤ç§¯åˆ†
       â†˜          â†™
         AI ç”Ÿæˆ
```

---

## ç´§æ€¥è¡ŒåŠ¨é¡¹

### ğŸ”´ ç«‹å³æ‰§è¡Œï¼šå¯ç”¨ RLS

1. ç™»å½• Supabase SQL Editor
2. æ‰§è¡Œä»¥ä¸‹ SQLï¼š

```sql
-- æ‰¹é‡å¯ç”¨ RLS
DO $$ 
DECLARE 
  r RECORD;
BEGIN
  FOR r IN SELECT tablename FROM pg_tables 
  WHERE schemaname = 'public' 
  LOOP
    EXECUTE 'ALTER TABLE ' || quote_ident(r.tablename) || ' ENABLE ROW LEVEL SECURITY;';
  END LOOP;
END $$;

-- åˆ›å»ºåŸºæœ¬ç­–ç•¥
-- ç”¨æˆ·ç›¸å…³è¡¨ï¼šåªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
CREATE POLICY "Own data only" ON users FOR ALL USING (auth.uid()::text = user_uuid);
CREATE POLICY "Own data only" ON credits FOR ALL USING (auth.uid()::text = user_uuid);
CREATE POLICY "Own data only" ON orders FOR ALL USING (auth.uid()::text = user_email);
CREATE POLICY "Own data only" ON subscriptions FOR ALL USING (auth.uid()::text = user_uuid);
CREATE POLICY "Own data only" ON subscription_usage FOR ALL USING (auth.uid()::text = user_uuid);

-- å…¬å¼€è¡¨ï¼šæ‰€æœ‰äººå¯è¯»
CREATE POLICY "Public read" ON subscription_plans FOR SELECT USING (true);
CREATE POLICY "Public read" ON posts FOR SELECT USING (status = 'online');
```

### éªŒè¯ RLS çŠ¶æ€
æ‰§è¡Œåï¼ŒTable Editor ä¸­çš„ "Unrestricted" æ ‡è®°åº”è¯¥æ¶ˆå¤±ï¼Œå˜ä¸ºå¸¦é”çš„å›¾æ ‡ã€‚

---

## å‚è€ƒèµ„æº

- [Supabase RLS æ–‡æ¡£](https://supabase.com/docs/guides/auth/row-level-security)
- [Drizzle ORM è¿ç§»æŒ‡å—](https://orm.drizzle.team/docs/migrations)
- [ShipAny æ•°æ®åº“æ–‡æ¡£](https://docs.shipany.ai/zh/features/database)

---

*æœ€åæ›´æ–°ï¼š2025-01-15*
*ä½œè€…ï¼šClaude Assistant*