# ä»£ç æ³¨é‡Šè§„èŒƒä¿®æ­£è®¡åˆ’

## ğŸ“‹ é—®é¢˜è¯´æ˜
å‘ç° `src/middleware.ts` æ–‡ä»¶ä½¿ç”¨äº†è‹±æ–‡æ³¨é‡Šï¼Œä¸ç¬¦åˆé¡¹ç›®ä¸­æ–‡æ³¨é‡Šè§„èŒƒã€‚

## ğŸ” éœ€è¦ä¿®æ­£çš„æ–‡ä»¶

### é«˜ä¼˜å…ˆçº§ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
- [ ] `src/middleware.ts` - ç”¨æˆ·å½’å› ç³»ç»Ÿä¸­é—´ä»¶
  - å½“å‰çŠ¶æ€ï¼šè‹±æ–‡æ³¨é‡Š
  - ä¿®æ­£æ–¹æ¡ˆï¼šä¿ç•™æŠ€æœ¯æœ¯è¯­ï¼Œå…¶ä»–è¯´æ˜æ”¹ä¸ºä¸­æ–‡

### ä¸­ä¼˜å…ˆçº§ï¼ˆå¯èƒ½éœ€è¦æ£€æŸ¥ï¼‰
- [ ] `src/services/config.ts` - éƒ¨åˆ†è‹±æ–‡æ³¨é‡Š
- [ ] `src/auth/config.ts` - æ··åˆæ³¨é‡Š

## ğŸ¯ ä¿®æ­£åŸåˆ™

### 1. ä¿ç•™è‹±æ–‡çš„æƒ…å†µ
- æŠ€æœ¯æœ¯è¯­ï¼ˆå¦‚ UTMã€Cookieã€referrerï¼‰
- æ ‡å‡†æ¦‚å¿µï¼ˆå¦‚ first-touch attributionã€last-touch attributionï¼‰
- API å‚æ•°åå’Œè¿”å›å€¼è¯´æ˜

### 2. æ”¹ä¸ºä¸­æ–‡çš„æƒ…å†µ
- åŠŸèƒ½è¯´æ˜
- å®ç°é€»è¾‘æè¿°
- ä½¿ç”¨åœºæ™¯è¯´æ˜
- æ³¨æ„äº‹é¡¹

### 3. ç¤ºä¾‹å¯¹æ¯”

**ä¿®æ­£å‰ï¼ˆçº¯è‹±æ–‡ï¼‰**ï¼š
```typescript
/**
 * Parse UTM parameters from URL
 */
```

**ä¿®æ­£åï¼ˆä¸­è‹±æ··åˆï¼‰**ï¼š
```typescript
/**
 * è§£æ URL ä¸­çš„ UTM å‚æ•°
 * UTM (Urchin Tracking Module) ç”¨äºè¿½è¸ªè¥é”€æ´»åŠ¨æ•ˆæœ
 */
```

## ğŸ“ middleware.ts æ³¨é‡Šä¿®æ­£å¯¹ç…§è¡¨

| åŸè‹±æ–‡æ³¨é‡Š | å»ºè®®ä¸­æ–‡æ³¨é‡Š |
|-----------|------------|
| Next.js Enhanced Middleware Configuration | Next.js å¢å¼ºä¸­é—´ä»¶é…ç½® |
| Internationalization (i18n) routing | å›½é™…åŒ–ï¼ˆi18nï¼‰è·¯ç”± |
| User attribution tracking | ç”¨æˆ·å½’å› è¿½è¸ª |
| Cookie-based visitor identification | åŸºäº Cookie çš„è®¿å®¢è¯†åˆ« |
| How it works | å·¥ä½œåŸç† |
| Combines next-intl middleware with custom attribution tracking | ç»“åˆ next-intl ä¸­é—´ä»¶ä¸è‡ªå®šä¹‰å½’å› è¿½è¸ª |
| Tracks user source, device, and journey through the site | è¿½è¸ªç”¨æˆ·æ¥æºã€è®¾å¤‡å’Œç«™å†…è®¿é—®è·¯å¾„ |
| Maintains both first-touch and last-touch attribution | åŒæ—¶ç»´æŠ¤é¦–æ¬¡è§¦è¾¾å’Œæœ€åè§¦è¾¾å½’å›  |
| Parse UTM parameters from URL | è§£æ URL ä¸­çš„ UTM å‚æ•° |
| Parse referrer to identify source | è§£æ referrer è¯†åˆ«æ¥æº |
| Generate unique IDs | ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ |
| Attribution tracking middleware | å½’å› è¿½è¸ªä¸­é—´ä»¶ |
| Skip attribution for API routes and static files | è·³è¿‡ API è·¯ç”±å’Œé™æ€æ–‡ä»¶çš„å½’å› å¤„ç† |
| Get existing attribution cookie | è·å–ç°æœ‰çš„å½’å›  Cookie |
| Parse current visit data | è§£æå½“å‰è®¿é—®æ•°æ® |
| Initialize or update attribution | åˆå§‹åŒ–æˆ–æ›´æ–°å½’å› ä¿¡æ¯ |
| First visit - create new attribution | é¦–æ¬¡è®¿é—® - åˆ›å»ºæ–°çš„å½’å› è®°å½• |
| Returning visitor - update last-touch attribution | å›è®¿ç”¨æˆ· - æ›´æ–°æœ€åè§¦è¾¾å½’å›  |
| Update session if more than 30 minutes since last visit | å¦‚æœè·ç¦»ä¸Šæ¬¡è®¿é—®è¶…è¿‡30åˆ†é’Ÿï¼Œæ›´æ–°ä¼šè¯ |
| Set the attribution cookie | è®¾ç½®å½’å›  Cookie |
| Add visitor ID to response headers for client-side access | æ·»åŠ è®¿å®¢ ID åˆ°å“åº”å¤´ä¾›å®¢æˆ·ç«¯è®¿é—® |
| Main middleware function | ä¸»ä¸­é—´ä»¶å‡½æ•° |
| Combines i18n and attribution tracking | ç»“åˆ i18n å’Œå½’å› è¿½è¸ª |
| Merge cookies from both responses | åˆå¹¶ä¸¤ä¸ªå“åº”çš„ Cookie |
| Middleware configuration | ä¸­é—´ä»¶é…ç½® |
| Defines which paths should be processed | å®šä¹‰å“ªäº›è·¯å¾„éœ€è¦å¤„ç† |

## ğŸš€ æ‰§è¡Œè®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒæ–‡ä»¶ä¿®æ­£
1. ä¿®æ­£ `middleware.ts` çš„æ‰€æœ‰æ³¨é‡Š
2. ä¿ç•™æŠ€æœ¯æœ¯è¯­çš„è‹±æ–‡åŸæ–‡
3. æ·»åŠ å¿…è¦çš„ä¸­æ–‡è§£é‡Š

### ç¬¬äºŒé˜¶æ®µï¼šå…¨é¡¹ç›®æ£€æŸ¥
1. ä½¿ç”¨è„šæœ¬æ‰«ææ‰€æœ‰ `.ts` å’Œ `.tsx` æ–‡ä»¶
2. è¯†åˆ«è‹±æ–‡æ³¨é‡Š
3. æ‰¹é‡ä¿®æ­£æˆ–æ ‡è®°éœ€è¦äººå·¥å¤„ç†çš„éƒ¨åˆ†

### ç¬¬ä¸‰é˜¶æ®µï¼šè§„èŒƒè½å®
1. æ›´æ–° CLAUDE.mdï¼Œæ˜ç¡®æ³¨é‡Šè¯­è¨€è§„èŒƒ
2. æ·»åŠ  pre-commit hook æ£€æŸ¥æ³¨é‡Šè¯­è¨€
3. åˆ›å»ºæ³¨é‡Šæ¨¡æ¿

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **ä¸è¦è¿‡åº¦ç¿»è¯‘**ï¼šæŠ€æœ¯æœ¯è¯­ä¿æŒè‹±æ–‡æ›´æ¸…æ™°
2. **ä¿æŒä¸€è‡´æ€§**ï¼šåŒä¸€æ¦‚å¿µåœ¨æ•´ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨ç›¸åŒçš„ç¿»è¯‘
3. **è€ƒè™‘å¯è¯»æ€§**ï¼šä¸­è‹±æ··åˆæ—¶æ³¨æ„æ’ç‰ˆå’Œç©ºæ ¼
4. **ç‰ˆæœ¬æ§åˆ¶**ï¼šä¿®æ­£æ³¨é‡Šæ—¶åˆ›å»ºç‹¬ç«‹çš„ commit

---

*åˆ›å»ºæ—¶é—´ï¼š2025-08-17*
*çŠ¶æ€ï¼šå¾…æ‰§è¡Œ*