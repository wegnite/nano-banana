# æ€§èƒ½ä¼˜åŒ–å»ºè®®

## ğŸ“Š å½“å‰æ€§èƒ½åˆ†æ

åŸºäºé¡¹ç›®ä»£ç åˆ†æå’Œæ„å»ºè¾“å‡ºï¼Œä»¥ä¸‹æ˜¯é’ˆå¯¹ Vercel éƒ¨ç½²çš„æ€§èƒ½ä¼˜åŒ–å»ºè®®ã€‚

### æ„å»ºåˆ†ææ‘˜è¦
- **æ€»è·¯ç”±æ•°é‡ï¼š** 52ä¸ªè·¯ç”±
- **æœ€å¤§é¡µé¢å¤§å°ï¼š** 988 kB (admin/posts ç¼–è¾‘é¡µé¢)
- **é¦–é¡µå¤§å°ï¼š** 730 kB
- **å…±äº« JSï¼š** 101 kB
- **ä¸­é—´ä»¶å¤§å°ï¼š** 43.5 kB

## ğŸ¯ æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥

### 1. JavaScript Bundle ä¼˜åŒ–

#### é—®é¢˜åˆ†æ
- ç®¡ç†åå°é¡µé¢è¿‡å¤§ï¼ˆ988 kBï¼‰
- é¦–é¡µåŠ è½½è´Ÿæ‹…é‡ï¼ˆ730 kBï¼‰
- æŸäº›é¡µé¢åŒ…å«è¿‡å¤š JavaScript

#### ä¼˜åŒ–æ–¹æ¡ˆ

**A. ä»£ç åˆ†å‰²ä¼˜åŒ–**
```typescript
// æ‡’åŠ è½½é‡ç»„ä»¶
const AIGenerator = dynamic(() => import('@/components/blocks/ai-generator'), {
  loading: () => <div>Loading AI Generator...</div>,
  ssr: false // å¯¹äºçº¯å®¢æˆ·ç«¯ç»„ä»¶
});

const AdminPosts = dynamic(() => import('@/components/admin/posts'), {
  loading: () => <AdminSkeleton />,
});
```

**B. Bundle Analyzer é…ç½®**
```bash
# å¼€å¯ bundle åˆ†æ
ANALYZE=true npm run build
```

**C. ç¬¬ä¸‰æ–¹åº“ä¼˜åŒ–**
```typescript
// æŒ‰éœ€å¼•å…¥
import { Button } from '@/components/ui/button';
// è€Œä¸æ˜¯
import * as UI from '@/components/ui';

// Tree shaking ä¼˜åŒ–
import { debounce } from 'lodash/debounce';
// è€Œä¸æ˜¯
import _ from 'lodash';
```

### 2. å›¾ç‰‡ä¼˜åŒ–ç­–ç•¥

#### é—®é¢˜åˆ†æ
æ„å»ºæ—¥å¿—æ˜¾ç¤ºå¤šå¤„ä½¿ç”¨ `<img>` æ ‡ç­¾è€Œé Next.js Image ç»„ä»¶ã€‚

#### ä¼˜åŒ–æ–¹æ¡ˆ

**A. ç»Ÿä¸€ä½¿ç”¨ Next.js Image**
```typescript
import Image from 'next/image';

// æ›¿æ¢æ‰€æœ‰ <img> æ ‡ç­¾
<Image
  src="/imgs/features/1.png"
  alt="Feature description"
  width={800}
  height={600}
  priority={isAboveFold}
  placeholder="blur"
  blurDataURL="data:image/jpeg;base64,..."
/>
```

**B. Cloudflare R2 + å›¾ç‰‡ä¼˜åŒ–**
```typescript
// é…ç½®å›¾ç‰‡ä¼˜åŒ–åŸŸå
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'pub-*.r2.dev', // ä½ çš„ R2 åŸŸå
        pathname: '/**',
      },
    ],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
  },
};
```

**C. å›¾ç‰‡æ ¼å¼ä¼˜åŒ–**
```typescript
// ä¼˜å…ˆä½¿ç”¨ç°ä»£å›¾ç‰‡æ ¼å¼
const imageFormats = {
  webp: 'image/webp',
  avif: 'image/avif',
  jpeg: 'image/jpeg'
};

// å“åº”å¼å›¾ç‰‡
<Image
  src="/image.jpg"
  alt="Description"
  sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
  width={1200}
  height={800}
/>
```

### 3. API è·¯ç”±ä¼˜åŒ–

#### é—®é¢˜åˆ†æ
- å¤§é‡ API è·¯ç”±å¯èƒ½å½±å“å†·å¯åŠ¨
- AI API è°ƒç”¨å¯èƒ½è€—æ—¶è¾ƒé•¿

#### ä¼˜åŒ–æ–¹æ¡ˆ

**A. API å“åº”ç¼“å­˜**
```typescript
// åœ¨ API è·¯ç”±ä¸­æ·»åŠ ç¼“å­˜
export async function GET(request: NextRequest) {
  const response = NextResponse.json(data);
  
  // è®¾ç½®ç¼“å­˜å¤´
  response.headers.set('Cache-Control', 'public, s-maxage=60, stale-while-revalidate=300');
  
  return response;
}
```

**B. Edge Runtime ä¼˜åŒ–**
```typescript
// å¯¹äºç®€å•çš„ API ä½¿ç”¨ Edge Runtime
export const runtime = 'edge';

export async function GET(request: Request) {
  // å¿«é€Ÿå“åº”çš„é€»è¾‘
}
```

**C. API è¶…æ—¶å’Œé‡è¯•**
```typescript
// nano-banana service å·²å®ç°ï¼Œç»§ç»­ä¼˜åŒ–
const TIMEOUT_CONFIG = {
  short: 5000,   // 5s for quick operations
  medium: 30000, // 30s for AI generation
  long: 60000,   // 60s for complex operations
};
```

### 4. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

#### ä¼˜åŒ–æ–¹æ¡ˆ

**A. è¿æ¥æ± ä¼˜åŒ–**
```typescript
// åœ¨ db/config.ts ä¸­ä¼˜åŒ–è¿æ¥æ± 
const config = {
  connectionString: process.env.DATABASE_URL,
  max: 20, // æœ€å¤§è¿æ¥æ•°
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
};
```

**B. æŸ¥è¯¢ä¼˜åŒ–**
```typescript
// ä½¿ç”¨ç´¢å¼•å’Œ limit
async function getUserCredits(user_uuid: string, limit = 100) {
  return await db
    .select()
    .from(credits)
    .where(eq(credits.user_uuid, user_uuid))
    .orderBy(desc(credits.created_at))
    .limit(limit);
}

// æ‰¹é‡æ“ä½œ
async function batchUpdateCredits(updates: CreditUpdate[]) {
  return await db.transaction(async (tx) => {
    for (const update of updates) {
      await tx.update(credits).set(update).where(eq(credits.id, update.id));
    }
  });
}
```

### 5. ç¼“å­˜ç­–ç•¥

#### A. Redis ç¼“å­˜å±‚
```typescript
// æ·»åŠ  Redis ç¼“å­˜
import { Redis } from '@upstash/redis';

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL,
  token: process.env.UPSTASH_REDIS_REST_TOKEN,
});

// ç¼“å­˜ç”¨æˆ·ç§¯åˆ†
export async function getCachedUserCredits(user_uuid: string) {
  const cached = await redis.get(`credits:${user_uuid}`);
  if (cached) return cached;
  
  const credits = await getUserCredits(user_uuid);
  await redis.setex(`credits:${user_uuid}`, 300, JSON.stringify(credits)); // 5åˆ†é’Ÿç¼“å­˜
  
  return credits;
}
```

#### B. é™æ€èµ„æºç¼“å­˜
```typescript
// next.config.mjs ä¸­é…ç½®ç¼“å­˜å¤´
const nextConfig = {
  async headers() {
    return [
      {
        source: '/imgs/:path*',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable',
          },
        ],
      },
    ];
  },
};
```

### 6. å›½é™…åŒ–ä¼˜åŒ–

#### é—®é¢˜åˆ†æ
å¤šè¯­è¨€å†…å®¹å¯èƒ½å½±å“é¦–é¡µåŠ è½½é€Ÿåº¦ã€‚

#### ä¼˜åŒ–æ–¹æ¡ˆ
```typescript
// æ‡’åŠ è½½è¯­è¨€åŒ…
const loadMessages = async (locale: string) => {
  switch (locale) {
    case 'zh':
      return (await import('@/i18n/messages/zh.json')).default;
    case 'en':
    default:
      return (await import('@/i18n/messages/en.json')).default;
  }
};
```

## ğŸš€ Vercel ç‰¹å®šä¼˜åŒ–

### 1. Vercel Functions ä¼˜åŒ–

**A. å‡½æ•°é…ç½®**
```json
// vercel.json
{
  "functions": {
    "app/api/nano-banana/**/*": {
      "maxDuration": 60,
      "memory": 1024
    },
    "app/api/demo/**/*": {
      "maxDuration": 30,
      "memory": 512
    },
    "app/api/**/*": {
      "maxDuration": 10,
      "memory": 256
    }
  },
  "regions": ["hkg1", "nrt1"], // é€‰æ‹©è·ç¦»ç”¨æˆ·æœ€è¿‘çš„åŒºåŸŸ
  "framework": "nextjs"
}
```

**B. è¾¹ç¼˜é…ç½®**
```typescript
// å¯¹äºé™æ€å†…å®¹ä½¿ç”¨è¾¹ç¼˜å‡½æ•°
export const config = {
  runtime: 'edge',
  regions: ['hkg1', 'nrt1'], // äºšå¤ªåœ°åŒº
};
```

### 2. ISR (å¢é‡é™æ€å†ç”Ÿæˆ) é…ç½®

```typescript
// å¯¹äºç›¸å¯¹é™æ€çš„é¡µé¢ä½¿ç”¨ ISR
export async function generateStaticParams() {
  return [
    { locale: 'en' },
    { locale: 'zh' },
    { locale: 'ja' }
  ];
}

export const revalidate = 3600; // æ¯å°æ—¶é‡æ–°ç”Ÿæˆ
```

## ğŸ“ˆ ç›‘æ§å’Œåˆ†æ

### 1. æ€§èƒ½ç›‘æ§è®¾ç½®

**A. Web Vitals ç›‘æ§**
```typescript
// pages/_app.tsx æˆ– app/layout.tsx
import { reportWebVitals } from '@/lib/analytics';

export function reportWebVitals(metric: NextWebVitalsMetric) {
  // å‘é€åˆ°åˆ†ææœåŠ¡
  if (process.env.NODE_ENV === 'production') {
    analytics.track('Web Vital', {
      name: metric.name,
      value: metric.value,
      id: metric.id,
    });
  }
}
```

**B. ç”¨æˆ·ä½“éªŒç›‘æ§**
```typescript
// ç›‘æ§å…³é”®ç”¨æˆ·æ“ä½œ
const trackPerformance = {
  imageGeneration: (startTime: number) => {
    const duration = Date.now() - startTime;
    analytics.track('AI Generation Performance', { duration });
  },
  pageLoad: (route: string, loadTime: number) => {
    analytics.track('Page Load', { route, loadTime });
  }
};
```

### 2. é”™è¯¯ç›‘æ§

```typescript
// æ·»åŠ é”™è¯¯è¾¹ç•Œå’Œç›‘æ§
import { captureException } from '@/lib/sentry';

export function GlobalErrorBoundary({ error }: { error: Error }) {
  useEffect(() => {
    captureException(error);
  }, [error]);
  
  return <ErrorUI error={error} />;
}
```

## ğŸ¯ å…·ä½“å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³å®æ–½ï¼‰
1. âœ… ä¿®å¤æ‰€æœ‰ TypeScript é”™è¯¯
2. âš¡ å°†å…³é”® `<img>` æ ‡ç­¾æ›¿æ¢ä¸º `<Image>` ç»„ä»¶
3. ğŸ“¦ å¯ç”¨ bundle analyzer åˆ†æåŒ…å¤§å°
4. âš™ï¸ ä¼˜åŒ– Vercel å‡½æ•°é…ç½®

### ç¬¬äºŒé˜¶æ®µï¼ˆ1-2å‘¨å†…ï¼‰
1. ğŸ”„ å®æ–½ Redis ç¼“å­˜å±‚
2. ğŸ¨ ä¼˜åŒ–å›¾ç‰‡åŠ è½½ç­–ç•¥
3. ğŸ“Š æ·»åŠ æ€§èƒ½ç›‘æ§
4. ğŸ—ƒï¸ æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

### ç¬¬ä¸‰é˜¶æ®µï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰
1. ğŸŒ CDN å’Œè¾¹ç¼˜è®¡ç®—ä¼˜åŒ–
2. ğŸ¤– AI API è°ƒç”¨ä¼˜åŒ–
3. ğŸ“± ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–
4. ğŸ” SEO å’Œ Core Web Vitals ä¼˜åŒ–

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

é€šè¿‡å®æ–½ä¸Šè¿°ä¼˜åŒ–ï¼Œé¢„æœŸå¯ä»¥è·å¾—ï¼š

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | æå‡ |
|------|------|------|------|
| é¦–é¡µåŠ è½½æ—¶é—´ | ~3s | ~1.5s | 50% |
| å›¾ç‰‡åŠ è½½æ—¶é—´ | ~2s | ~0.8s | 60% |
| API å“åº”æ—¶é—´ | ~500ms | ~200ms | 60% |
| Lighthouse è¯„åˆ† | ~70 | ~90+ | 20+ |
| Bundle å¤§å° | 730 kB | ~500 kB | 30% |

## ğŸ”§ å·¥å…·å’Œèµ„æº

### æ€§èƒ½åˆ†æå·¥å…·
- **Lighthouse:** ç»¼åˆæ€§èƒ½è¯„ä¼°
- **GTmetrix:** é¡µé¢åŠ è½½åˆ†æ
- **WebPageTest:** è¯¦ç»†æ€§èƒ½æµ‹è¯•
- **Vercel Analytics:** å®æ—¶ç”¨æˆ·ç›‘æ§

### ä¼˜åŒ–å·¥å…·
- **Bundle Analyzer:** JavaScript åŒ…åˆ†æ
- **ImageOptim:** å›¾ç‰‡å‹ç¼©
- **Sharp:** æœåŠ¡ç«¯å›¾ç‰‡å¤„ç†
- **Redis:** ç¼“å­˜å±‚

---

**æœ€åæ›´æ–°ï¼š** 2024å¹´12æœˆ
**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0

> ğŸ’¡ **å»ºè®®ï¼š** æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ã€‚å»ºè®®æ¯æœˆè¿›è¡Œä¸€æ¬¡æ€§èƒ½å®¡æŸ¥ï¼Œæ ¹æ®ç”¨æˆ·åé¦ˆå’Œç›‘æ§æ•°æ®è°ƒæ•´ä¼˜åŒ–ç­–ç•¥ã€‚