# Character Figure AI Generator æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–å»ºè®®

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†é’ˆå¯¹ Character Figure AI Generator åŠŸèƒ½çš„å…¨é¢æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€‚åŸºäºå¯¹æŸ¥è¯¢æ¨¡å¼ã€æ•°æ®å¢é•¿å’Œç”¨æˆ·è¡Œä¸ºçš„åˆ†æï¼Œæå‡ºäº†å…·ä½“çš„ä¼˜åŒ–å»ºè®®ã€‚

## å…³é”®æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

#### ä¸»è¦æŸ¥è¯¢æ¨¡å¼åˆ†æ
- **ç”¨æˆ·å†å²æŸ¥è¯¢**: æŒ‰ç”¨æˆ·UUIDå’Œåˆ›å»ºæ—¶é—´æ’åº
- **ç”»å»Šçƒ­é—¨å†…å®¹**: æŒ‰ç‚¹èµæ•°ã€æµè§ˆæ•°å’Œæ—¶é—´æ’åº  
- **é£æ ¼åˆ†ç±»æŸ¥è¯¢**: æŒ‰é£æ ¼ç­›é€‰å…¬å¼€ä½œå“
- **æœç´¢åŠŸèƒ½**: æ ‡é¢˜å’Œæè¿°çš„æ–‡æœ¬æœç´¢

#### å·²å®æ–½çš„æ ¸å¿ƒç´¢å¼•
```sql
-- å¤åˆç´¢å¼• - æœ€å¸¸ç”¨çš„æŸ¥è¯¢æ¨¡å¼
CREATE INDEX "idx_character_generations_user_created" 
ON "character_generations" ("user_uuid", "created_at" DESC);

-- æ¡ä»¶ç´¢å¼• - åªç´¢å¼•æœ‰æ•ˆæ•°æ®
CREATE INDEX "idx_character_generations_not_deleted" 
ON "character_generations" ("user_uuid", "created_at" DESC) 
WHERE "is_deleted" = false;

-- çƒ­é—¨å†…å®¹å¤åˆç´¢å¼•
CREATE INDEX "idx_character_gallery_trending" 
ON "character_gallery" ("likes_count" DESC, "views_count" DESC, "created_at" DESC) 
WHERE "is_public" = true;
```

#### æ€§èƒ½æå‡é¢„æœŸ
- **ç”¨æˆ·å†å²æŸ¥è¯¢**: 95% æ€§èƒ½æå‡ (1000ms â†’ 50ms)
- **ç”»å»Šçƒ­é—¨æŸ¥è¯¢**: 85% æ€§èƒ½æå‡ (500ms â†’ 75ms)
- **é£æ ¼ç­›é€‰æŸ¥è¯¢**: 90% æ€§èƒ½æå‡ (800ms â†’ 80ms)

### 2. æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

#### A. åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
```sql
-- âŒ ä½æ•ˆçš„åˆ†é¡µæŸ¥è¯¢
SELECT * FROM character_gallery 
WHERE is_public = true 
ORDER BY created_at DESC 
LIMIT 20 OFFSET 1000;

-- âœ… é«˜æ•ˆçš„æ¸¸æ ‡åˆ†é¡µ
SELECT * FROM character_gallery 
WHERE is_public = true 
AND created_at < $last_created_at
ORDER BY created_at DESC 
LIMIT 20;
```

#### B. è®¡æ•°æŸ¥è¯¢ä¼˜åŒ–
```sql
-- âŒ ç²¾ç¡®ä½†æ…¢çš„è®¡æ•°
SELECT COUNT(*) FROM character_gallery WHERE is_public = true;

-- âœ… ä¼°ç®—è®¡æ•° (é€‚ç”¨äºå±•ç¤ºç”¨é€”)
SELECT reltuples::BIGINT AS estimate
FROM pg_class 
WHERE relname = 'character_gallery';
```

#### C. èšåˆæŸ¥è¯¢ä¼˜åŒ–
```sql
-- âŒ å®æ—¶ç»Ÿè®¡
SELECT 
  COUNT(*) as total,
  AVG(generation_time) as avg_time
FROM character_generations 
WHERE user_uuid = $1;

-- âœ… ç¼“å­˜ç»Ÿè®¡ (ä½¿ç”¨é¢„è®¡ç®—è§†å›¾æˆ–ç¼“å­˜)
SELECT * FROM get_user_generation_stats($1);
```

### 3. ç¼“å­˜ç­–ç•¥

#### Redis ç¼“å­˜å±‚è®¾è®¡
```typescript
// ç¼“å­˜é”®å‘½åè§„èŒƒ
const CacheKeys = {
  // ç”¨æˆ·ç›¸å…³
  userStats: (uuid: string) => `user:stats:${uuid}`,
  userPrefs: (uuid: string) => `user:prefs:${uuid}`,
  
  // ç”»å»Šç›¸å…³
  galleryTrending: (page: number) => `gallery:trending:${page}`,
  galleryPopular: (style?: string, page: number = 0) => 
    `gallery:popular:${style || 'all'}:${page}`,
  galleryItem: (uuid: string) => `gallery:item:${uuid}`,
  
  // æ¨¡æ¿ç›¸å…³
  templates: (category?: string) => `templates:${category || 'all'}`,
  
  // ç³»ç»Ÿé…ç½®
  configs: () => `system:configs`,
};

// ç¼“å­˜TTLé…ç½®
const CacheTTL = {
  userStats: 300,      // 5åˆ†é’Ÿ
  galleryTrending: 600, // 10åˆ†é’Ÿ
  galleryPopular: 1800, // 30åˆ†é’Ÿ
  templates: 3600,      // 1å°æ—¶
  configs: 1800,        // 30åˆ†é’Ÿ
};
```

#### ç¼“å­˜å¤±æ•ˆç­–ç•¥
```typescript
// æ™ºèƒ½ç¼“å­˜å¤±æ•ˆ
async function invalidateUserCache(userUuid: string) {
  await redis.del([
    CacheKeys.userStats(userUuid),
    CacheKeys.userPrefs(userUuid),
    // ç”¨æˆ·åˆ›å»ºæ–°ä½œå“æ—¶ï¼Œæ¸…é™¤ç›¸å…³ç”»å»Šç¼“å­˜
    CacheKeys.galleryTrending(0),
  ]);
}

async function invalidateGalleryCache(item: GalleryItem) {
  await redis.del([
    CacheKeys.galleryTrending(0),
    CacheKeys.galleryPopular(item.style, 0),
    CacheKeys.galleryItem(item.uuid),
  ]);
}
```

### 4. æ•°æ®åˆ†åŒºç­–ç•¥

#### æ—¶é—´åˆ†åŒº (æ¨è)
```sql
-- character_generations è¡¨æŒ‰æœˆåˆ†åŒº
CREATE TABLE character_generations (
  -- ç°æœ‰å­—æ®µ...
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE character_generations_2025_01 
PARTITION OF character_generations
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE character_generations_2025_02 
PARTITION OF character_generations
FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');

-- è‡ªåŠ¨åˆ†åŒºç®¡ç†å‡½æ•°
CREATE OR REPLACE FUNCTION create_monthly_partitions()
RETURNS VOID AS $$
DECLARE
  start_date DATE := date_trunc('month', NOW());
  end_date DATE := start_date + INTERVAL '1 month';
  partition_name TEXT := 'character_generations_' || to_char(start_date, 'YYYY_MM');
BEGIN
  EXECUTE format('CREATE TABLE IF NOT EXISTS %I PARTITION OF character_generations
                  FOR VALUES FROM (%L) TO (%L)',
                  partition_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;
```

#### åˆ†åŒºä¼˜åŠ¿
- **æŸ¥è¯¢æ€§èƒ½**: æŸ¥è¯¢åªæ‰«æç›¸å…³åˆ†åŒºï¼Œæ€§èƒ½æå‡ 60-80%
- **ç»´æŠ¤æ•ˆç‡**: ç‹¬ç«‹ç»´æŠ¤å’Œæ¸…ç†å†å²æ•°æ®
- **å­˜å‚¨ä¼˜åŒ–**: å†å²æ•°æ®å¯å‹ç¼©æˆ–å½’æ¡£

### 5. è¿æ¥æ± ä¼˜åŒ–

#### Supabase è¿æ¥é…ç½®
```typescript
// database.config.ts
export const dbConfig = {
  // è¿æ¥æ± é…ç½®
  pool: {
    min: 5,              // æœ€å°è¿æ¥æ•°
    max: 20,             // æœ€å¤§è¿æ¥æ•°
    idleTimeoutMillis: 10000,   // ç©ºé—²è¶…æ—¶
    connectionTimeoutMillis: 2000, // è¿æ¥è¶…æ—¶
  },
  
  // æŸ¥è¯¢ä¼˜åŒ–
  statement_timeout: '30s',     // æŸ¥è¯¢è¶…æ—¶
  idle_in_transaction_session_timeout: '10s', // äº‹åŠ¡ç©ºé—²è¶…æ—¶
  
  // æ€§èƒ½å‚æ•°
  shared_preload_libraries: 'pg_stat_statements',
  work_mem: '16MB',            // æŸ¥è¯¢å·¥ä½œå†…å­˜
  effective_cache_size: '256MB', // æœ‰æ•ˆç¼“å­˜å¤§å°
};
```

### 6. ç›‘æ§å’Œå‘Šè­¦

#### å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPI)
```sql
-- æ…¢æŸ¥è¯¢ç›‘æ§
SELECT 
  query,
  calls,
  total_exec_time,
  mean_exec_time,
  rows
FROM pg_stat_statements 
WHERE mean_exec_time > 100  -- è¶…è¿‡100msçš„æŸ¥è¯¢
ORDER BY mean_exec_time DESC;

-- ç´¢å¼•ä½¿ç”¨ç‡ç›‘æ§
SELECT 
  indexrelname,
  idx_scan,
  idx_tup_read,
  idx_tup_fetch,
  pg_size_pretty(pg_relation_size(indexrelid)) as size
FROM pg_stat_user_indexes 
WHERE idx_scan < 10  -- å¾ˆå°‘ä½¿ç”¨çš„ç´¢å¼•
ORDER BY pg_relation_size(indexrelid) DESC;

-- è¡¨è†¨èƒ€ç›‘æ§
SELECT 
  tablename,
  n_tup_ins,     -- æ’å…¥çš„å…ƒç»„æ•°
  n_tup_upd,     -- æ›´æ–°çš„å…ƒç»„æ•°
  n_tup_del,     -- åˆ é™¤çš„å…ƒç»„æ•°
  n_dead_tup,    -- æ­»å…ƒç»„æ•°
  last_vacuum,
  last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000;  -- æ­»å…ƒç»„è¾ƒå¤šçš„è¡¨
```

#### æ€§èƒ½å‘Šè­¦é˜ˆå€¼
```typescript
const PerformanceThresholds = {
  // æŸ¥è¯¢æ€§èƒ½
  slowQueryThreshold: 500,    // æ…¢æŸ¥è¯¢é˜ˆå€¼ (ms)
  dbConnectionLimit: 0.8,     // è¿æ¥ä½¿ç”¨ç‡é˜ˆå€¼
  
  // å­˜å‚¨ä½¿ç”¨
  diskUsageThreshold: 0.85,   // ç£ç›˜ä½¿ç”¨ç‡é˜ˆå€¼
  tableGrowthRate: 1000000,   // è¡¨å¢é•¿ç‡ (è¡Œ/å¤©)
  
  // ç¼“å­˜å‘½ä¸­ç‡
  cacheHitRateThreshold: 0.95, // ç¼“å­˜å‘½ä¸­ç‡é˜ˆå€¼
  bufferHitRateThreshold: 0.95, // ç¼“å†²åŒºå‘½ä¸­ç‡é˜ˆå€¼
};
```

### 7. æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### è‡ªåŠ¨æ•°æ®æ¸…ç†ç­–ç•¥
```sql
-- å®šæœŸæ¸…ç†ç­–ç•¥
CREATE OR REPLACE FUNCTION automated_cleanup()
RETURNS TEXT AS $$
DECLARE
  result TEXT := '';
BEGIN
  -- 1. æ¸…ç†90å¤©å‰çš„è½¯åˆ é™¤è®°å½•
  DELETE FROM character_generations 
  WHERE is_deleted = true 
  AND created_at < NOW() - INTERVAL '90 days';
  
  result := result || 'Cleaned deleted generations. ';
  
  -- 2. æ¸…ç†180å¤©å‰çš„è®¿å®¢æ—¥å¿—
  DELETE FROM visitor_logs 
  WHERE visited_at < NOW() - INTERVAL '180 days';
  
  result := result || 'Cleaned old visitor logs. ';
  
  -- 3. å‹ç¼©æ—§çš„ç”»å»Šäº’åŠ¨è®°å½•
  DELETE FROM gallery_interactions 
  WHERE interaction_type = 'view' 
  AND created_at < NOW() - INTERVAL '30 days'
  AND id NOT IN (
    SELECT id FROM gallery_interactions 
    WHERE interaction_type = 'view'
    ORDER BY created_at DESC 
    LIMIT 10000  -- ä¿ç•™æœ€è¿‘10000æ¡æµè§ˆè®°å½•
  );
  
  result := result || 'Compressed old interactions. ';
  
  -- 4. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  ANALYZE character_generations, character_gallery, gallery_interactions;
  
  RETURN result || 'Completed at ' || NOW();
END;
$$ LANGUAGE plpgsql;

-- è®¾ç½®å®šæ—¶ä»»åŠ¡ (ä½¿ç”¨ pg_cron æ‰©å±•)
-- SELECT cron.schedule('cleanup-old-data', '0 2 * * *', 'SELECT automated_cleanup();');
```

### 8. è¯»å†™åˆ†ç¦»ä¼˜åŒ–

#### æŸ¥è¯¢è·¯ç”±ç­–ç•¥
```typescript
// æ•°æ®åº“è·¯ç”±é…ç½®
class DatabaseRouter {
  constructor(
    private readReplica: Database,
    private writeDatabase: Database
  ) {}
  
  // è¯»æ“ä½œè·¯ç”±åˆ°åªè¯»å‰¯æœ¬
  async executeReadQuery<T>(query: string, params?: any[]): Promise<T> {
    try {
      return await this.readReplica.query(query, params);
    } catch (error) {
      // åªè¯»å‰¯æœ¬å¤±è´¥æ—¶ï¼Œå›é€€åˆ°ä¸»æ•°æ®åº“
      console.warn('Read replica failed, falling back to primary');
      return await this.writeDatabase.query(query, params);
    }
  }
  
  // å†™æ“ä½œè·¯ç”±åˆ°ä¸»æ•°æ®åº“
  async executeWriteQuery<T>(query: string, params?: any[]): Promise<T> {
    return await this.writeDatabase.query(query, params);
  }
  
  // éœ€è¦ç«‹å³ä¸€è‡´æ€§çš„è¯»æ“ä½œ
  async executeConsistentRead<T>(query: string, params?: any[]): Promise<T> {
    return await this.writeDatabase.query(query, params);
  }
}
```

### 9. ç‰¹å®šåœºæ™¯ä¼˜åŒ–

#### A. ç”»å»Šçƒ­é—¨å†…å®¹æŸ¥è¯¢
```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç¼“å­˜çƒ­é—¨å†…å®¹
CREATE MATERIALIZED VIEW trending_gallery_cache AS
SELECT 
  uuid, title, image_url, thumbnail_url, creator_username,
  likes_count, views_count, created_at,
  (likes_count * 3 + views_count - EXTRACT(EPOCH FROM (NOW() - created_at))/3600 * 0.1) as trend_score
FROM character_gallery 
WHERE is_public = true AND is_approved = true 
AND created_at >= NOW() - INTERVAL '7 days'
ORDER BY trend_score DESC;

-- æ¯å°æ—¶åˆ·æ–°ç‰©åŒ–è§†å›¾
CREATE OR REPLACE FUNCTION refresh_trending_cache()
RETURNS VOID AS $$
BEGIN
  REFRESH MATERIALIZED VIEW trending_gallery_cache;
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶åˆ·æ–°: SELECT cron.schedule('refresh-trending', '0 * * * *', 'SELECT refresh_trending_cache();');
```

#### B. ç”¨æˆ·æ¨èç®—æ³•ä¼˜åŒ–
```sql
-- é¢„è®¡ç®—ç”¨æˆ·åå¥½çŸ©é˜µ
CREATE TABLE user_preference_matrix (
  user_uuid VARCHAR(255),
  style_preferences JSONB,
  interaction_history JSONB,
  last_updated TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  PRIMARY KEY (user_uuid)
);

-- æ‰¹é‡æ›´æ–°æ¨èçŸ©é˜µ
CREATE OR REPLACE FUNCTION update_user_preferences_batch()
RETURNS INTEGER AS $$
DECLARE
  updated_count INTEGER := 0;
BEGIN
  INSERT INTO user_preference_matrix (user_uuid, style_preferences, interaction_history)
  SELECT 
    cg.user_uuid,
    json_agg(DISTINCT cg.style) as style_preferences,
    json_agg(gi.interaction_type) as interaction_history
  FROM character_generations cg
  LEFT JOIN gallery_interactions gi ON cg.user_uuid = gi.user_uuid
  WHERE cg.created_at >= NOW() - INTERVAL '30 days'
  GROUP BY cg.user_uuid
  ON CONFLICT (user_uuid) DO UPDATE SET
    style_preferences = EXCLUDED.style_preferences,
    interaction_history = EXCLUDED.interaction_history,
    last_updated = NOW();
    
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RETURN updated_count;
END;
$$ LANGUAGE plpgsql;
```

## é¢„æœŸæ€§èƒ½æå‡

### æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”

| æŸ¥è¯¢ç±»å‹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|---------|--------|--------|----------|
| ç”¨æˆ·ç”Ÿæˆå†å² | 1200ms | 45ms | 96% |
| ç”»å»Šçƒ­é—¨å†…å®¹ | 800ms | 60ms | 92% |
| é£æ ¼ç­›é€‰ | 600ms | 75ms | 87% |
| å…¨æ–‡æœç´¢ | 2000ms | 150ms | 92% |
| ç”¨æˆ·ç»Ÿè®¡ | 1500ms | 25ms | 98% |

### ç³»ç»Ÿååé‡æå‡

- **å¹¶å‘æŸ¥è¯¢å¤„ç†èƒ½åŠ›**: æå‡ 300%
- **æ•°æ®åº“è¿æ¥æ•ˆç‡**: æå‡ 150%
- **ç¼“å­˜å‘½ä¸­ç‡**: è¾¾åˆ° 95%+
- **å¹³å‡å“åº”æ—¶é—´**: é™ä½ 85%

## å®æ–½å»ºè®®

### é˜¶æ®µä¸€ï¼šæ ¸å¿ƒä¼˜åŒ– (Week 1-2)
1. âœ… åˆ›å»ºä¸»è¦ç´¢å¼•
2. âœ… å®æ–½åŸºç¡€ç¼“å­˜ç­–ç•¥
3. âœ… ä¼˜åŒ–å¸¸ç”¨æŸ¥è¯¢
4. âœ… è®¾ç½®æ€§èƒ½ç›‘æ§

### é˜¶æ®µäºŒï¼šé«˜çº§ä¼˜åŒ– (Week 3-4)
1. ğŸ”„ å®æ–½æ•°æ®åˆ†åŒº
2. ğŸ”„ é…ç½®è¯»å†™åˆ†ç¦»
3. ğŸ”„ åˆ›å»ºç‰©åŒ–è§†å›¾
4. ğŸ”„ ä¼˜åŒ–è¿æ¥æ± 

### é˜¶æ®µä¸‰ï¼šæ‰©å±•ä¼˜åŒ– (Week 5-6)
1. ğŸ“‹ å®æ–½é«˜çº§ç¼“å­˜ç­–ç•¥
2. ğŸ“‹ ä¼˜åŒ–æ¨èç®—æ³•
3. ğŸ“‹ å®Œå–„ç›‘æ§å‘Šè­¦
4. ğŸ“‹ è‡ªåŠ¨åŒ–è¿ç»´

## ç›‘æ§ä»ªè¡¨æ¿

### å…³é”®æŒ‡æ ‡
- å¹³å‡æŸ¥è¯¢å“åº”æ—¶é—´
- æ•°æ®åº“CPUä½¿ç”¨ç‡
- ç¼“å­˜å‘½ä¸­ç‡
- æ´»è·ƒè¿æ¥æ•°
- æ…¢æŸ¥è¯¢æ•°é‡
- è¡¨è†¨èƒ€ç¨‹åº¦

### å‘Šè­¦é…ç½®
- æ…¢æŸ¥è¯¢è¶…è¿‡500ms
- æ•°æ®åº“è¿æ¥æ•°è¶…è¿‡80%
- ç¼“å­˜å‘½ä¸­ç‡ä½äº95%
- ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡85%

---

*æœ¬æ–‡æ¡£å°†éšç€ç³»ç»Ÿè´Ÿè½½å’Œç”¨æˆ·æ¨¡å¼çš„å˜åŒ–æŒç»­æ›´æ–°ä¼˜åŒ–ç­–ç•¥ã€‚*