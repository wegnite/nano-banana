# AI通用生成器 - 项目架构文档

## 📋 项目概述

**项目名称**：AI通用生成器（AI Universal Generator）  
**版本**：v2.6.0  
**技术栈**：Next.js 14+ / TypeScript / PostgreSQL / Drizzle ORM  
**部署环境**：Vercel / Docker / 自托管  

### 核心功能
- 🤖 多AI提供商集成（OpenAI、DeepSeek、OpenRouter、SiliconFlow）
- 💳 双支付系统（Stripe + Creem）
- 📊 完整用户归因追踪系统
- 🔐 OAuth认证（Google + GitHub）
- 🌐 国际化支持（中文/英文）
- 💰 混合计费模式（订阅制 + 积分制）

## 🏗 技术架构

### 前端技术栈
```
├── Next.js 14.x        # App Router架构
├── React 18.x          # UI框架
├── TypeScript 5.x      # 类型系统
├── Tailwind CSS 3.x    # 样式框架
├── Shadcn/ui          # UI组件库
├── next-intl          # 国际化方案
└── next-auth v5       # 认证系统
```

### 后端技术栈
```
├── Node.js 20.x       # 运行环境
├── PostgreSQL         # 主数据库
├── Drizzle ORM        # 数据库ORM
├── AI SDK             # AI模型集成
├── Vercel AI SDK      # 流式响应
└── Cloudflare R2      # 对象存储
```

### AI提供商集成
```
├── OpenAI             # GPT-4、DALL-E 3
├── DeepSeek           # DeepSeek R1推理模型
├── OpenRouter         # 多模型聚合平台
├── SiliconFlow        # 国产AI模型
├── Replicate          # 开源模型平台
└── Kling             # 视频生成模型
```

## 📁 项目结构

```
ai-shipany-v2.6.0-ai_model/
├── src/
│   ├── app/                      # Next.js App Router
│   │   ├── [locale]/             # 国际化路由
│   │   │   ├── (default)/        # 默认布局页面
│   │   │   ├── (admin)/          # 管理后台
│   │   │   ├── (docs)/           # 文档系统
│   │   │   └── auth/             # 认证页面
│   │   └── api/                  # API路由
│   │       ├── attribution/      # 归因追踪API
│   │       ├── demo/             # AI生成演示API
│   │       ├── pay/              # 支付回调API
│   │       └── user/             # 用户管理API
│   │
│   ├── components/               # React组件
│   │   ├── blocks/              # 页面区块组件
│   │   ├── ui/                  # 基础UI组件
│   │   ├── attribution/         # 归因追踪组件
│   │   └── subscription/        # 订阅管理组件
│   │
│   ├── services/                # 业务服务层
│   │   ├── attribution.ts       # 归因服务
│   │   ├── subscription.ts      # 订阅服务
│   │   ├── credit.ts           # 积分服务
│   │   ├── context7.ts         # Context7集成
│   │   └── user.ts             # 用户服务
│   │
│   ├── db/                     # 数据库层
│   │   ├── schema.ts           # 数据库模式定义
│   │   ├── index.ts            # 数据库连接
│   │   └── migrations/         # 数据库迁移文件
│   │
│   ├── lib/                    # 工具库
│   │   ├── utils.ts           # 通用工具函数
│   │   ├── resp.ts            # 响应格式化
│   │   └── storage.ts         # 存储服务
│   │
│   ├── i18n/                   # 国际化
│   │   ├── messages/          # 翻译文件
│   │   └── pages/             # 页面级翻译
│   │
│   └── types/                  # TypeScript类型定义
│       ├── global.d.ts        # 全局类型
│       └── next-auth.d.ts    # 认证类型扩展
│
├── public/                     # 静态资源
│   └── imgs/                  # 图片资源
│
├── docs/                      # 项目文档
├── test/                      # 测试文件
└── content/                   # MDX内容文件
```

## 🗄 数据库设计

### 核心数据表

#### 1. users - 用户表
- **基础信息**：uuid、email、昵称、头像
- **认证信息**：OAuth提供商、登录IP
- **归因追踪**：17个归因字段（来源、设备、地理位置等）
- **邀请系统**：邀请码、推广关系

#### 2. orders - 订单表
- **订单信息**：订单号、金额、状态
- **支付集成**：Stripe/Creem会话ID
- **订单归因**：13个归因字段（下单设备、位置等）

#### 3. subscriptions - 订阅表
- **订阅计划**：计划ID、价格、周期
- **状态管理**：激活、取消、过期
- **使用限制**：月度限额、已用次数

#### 4. visitor_logs - 访问日志表
- **访客追踪**：访客ID、会话ID
- **UTM参数**：完整UTM追踪
- **设备信息**：UA、浏览器、操作系统
- **地理位置**：IP地址、国家、城市

#### 5. credits - 积分表
- **交易记录**：充值、消费、过期
- **关联订单**：订单号关联

## 🔐 认证与授权

### NextAuth v5配置
```typescript
// 支持的OAuth提供商
- Google OAuth 2.0
- GitHub OAuth
- 邮箱登录（预留）

// 会话策略
- JWT Token
- 30天有效期
- HttpOnly Cookie
```

### 用户角色
- **普通用户**：基础AI生成功能
- **订阅用户**：无限生成、优先队列
- **管理员**：后台管理、数据分析

## 💰 支付系统

### 双支付渠道

#### 1. Stripe（国际支付）
- 信用卡支付
- 订阅管理
- Webhook回调
- 退款处理

#### 2. Creem（国内支付）
- 支付宝/微信
- 一次性付款
- 订单回调
- 产品映射

### 计费模式

#### 积分制
- 按次计费
- 积分充值
- 积分过期机制
- 使用记录追踪

#### 订阅制
- 月付/年付
- 自动续费
- 使用限制
- 升级/降级

## 📊 归因系统

### Cookie染色技术
- 30天持久化追踪
- 跨会话识别
- 首次/最后接触归因

### 数据采集维度
```
├── UTM参数追踪
│   ├── utm_source    # 来源
│   ├── utm_medium    # 媒介
│   ├── utm_campaign  # 活动
│   ├── utm_term      # 关键词
│   └── utm_content   # 内容
│
├── 设备信息
│   ├── 设备类型（PC/移动/平板）
│   ├── 操作系统
│   ├── 浏览器
│   └── 屏幕分辨率
│
└── 地理位置
    ├── 国家
    ├── 省份/州
    └── 城市
```

### 分析API端点
- `/api/attribution/analytics`
  - overview - 概览数据
  - channels - 渠道分析
  - devices - 设备分析
  - locations - 地理分析
  - conversions - 转化漏斗

## 🚀 部署架构

### 生产环境
```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│   Vercel    │────▶│  PostgreSQL  │────▶│ Cloudflare  │
│  (Next.js)  │     │  (Supabase)  │     │     R2      │
└─────────────┘     └──────────────┘     └─────────────┘
       │                    │                     │
       ▼                    ▼                     ▼
┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│   AI APIs   │     │   Analytics  │     │   Storage   │
│ (OpenAI等)  │     │  (归因分析)  │     │  (文件存储) │
└─────────────┘     └──────────────┘     └─────────────┘
```

### 环境变量配置
```env
# 数据库
DATABASE_URL=postgresql://...

# 认证
AUTH_SECRET=...
AUTH_GOOGLE_ID=...
AUTH_GITHUB_ID=...

# AI提供商
OPENAI_API_KEY=...
DEEPSEEK_API_KEY=...
OPENROUTER_API_KEY=...
SILICONFLOW_API_KEY=...

# 支付
STRIPE_PUBLIC_KEY=...
CREEM_API_KEY=...

# 存储
STORAGE_ENDPOINT=...
STORAGE_ACCESS_KEY=...
```

## 🔄 开发流程

### 本地开发
```bash
# 安装依赖
pnpm install

# 数据库迁移
npm run db:migrate

# 启动开发服务器
npm run dev

# 类型检查
npx tsc --noEmit

# 代码检查
npm run lint
```

### Git工作流
```bash
# 功能分支开发
git checkout -b feature/xxx

# 提交规范
git commit -m "feat: 添加新功能"
git commit -m "fix: 修复问题"
git commit -m "docs: 更新文档"

# 合并到主分支
git checkout main
git merge feature/xxx
```

### 测试策略
```bash
# 单元测试
npm run test:unit

# 集成测试
npm run test:integration

# 端到端测试
npm run test:e2e

# 归因系统测试
node test/verify-attribution.js
```

## 📈 监控与分析

### 性能监控
- Vercel Analytics
- Google Analytics
- OpenPanel
- Plausible Analytics

### 错误追踪
- Console日志
- API错误响应
- 数据库查询日志

### 用户行为分析
- 访问日志记录
- 转化漏斗分析
- 渠道效果评估
- 设备分布统计

## 🔒 安全措施

### 数据安全
- HTTPS强制
- SQL注入防护
- XSS防护
- CSRF保护

### API安全
- Rate Limiting
- API Key验证
- JWT Token
- IP白名单（可选）

### 敏感信息管理
- 环境变量隔离
- 密钥加密存储
- 日志脱敏
- 数据备份

## 📚 相关文档

- [用户归因系统架构设计](./用户归因系统架构设计.md)
- [支付合规调整记录](./支付合规调整记录.md)
- [Context7集成完成报告](./Context7集成完成报告.md)
- [数据库迁移与安全配置指南](./数据库迁移与安全配置指南.md)
- [完整项目指南](./完整项目指南.md)

## 🎯 未来规划

### 短期目标（1-3个月）
- [ ] 添加更多AI模型支持
- [ ] 优化归因分析仪表板
- [ ] 实现A/B测试框架
- [ ] 增强错误处理机制

### 中期目标（3-6个月）
- [ ] 开发移动应用
- [ ] 实现实时协作功能
- [ ] 添加更多支付渠道
- [ ] 构建插件系统

### 长期目标（6-12个月）
- [ ] 多租户SaaS架构
- [ ] 自托管解决方案
- [ ] AI模型微调平台
- [ ] 企业级功能

---

*文档版本：v1.0*  
*更新日期：2025-08-17*  
*维护者：AI ShipAny Team*