# 代码规范文档

## 📋 总体原则

### 核心理念
1. **可读性优先** - 代码是写给人看的，顺便给机器执行
2. **简洁但不简陋** - 追求简洁，但不牺牲可理解性
3. **一致性** - 保持项目内代码风格的一致性
4. **中文注释** - 所有注释必须使用中文，便于团队协作

## 🎨 编码规范

### TypeScript/JavaScript

#### 命名规范
```typescript
// ✅ 正确示例

// 常量：全大写，下划线分隔
const MAX_RETRY_COUNT = 3;
const DEFAULT_TIMEOUT = 5000;

// 变量：小驼峰
const userName = "张三";
const isLoggedIn = true;

// 函数：小驼峰，动词开头
function getUserInfo() { }
function calculateTotal() { }
function validateEmail() { }

// 类：大驼峰
class UserService { }
class AttributionTracker { }

// 接口：大驼峰，I前缀（可选）
interface UserProfile { }
interface IApiResponse { }

// 类型：大驼峰
type PaymentStatus = "pending" | "paid" | "failed";

// 枚举：大驼峰，值全大写
enum UserRole {
  ADMIN = "admin",
  USER = "user",
  GUEST = "guest"
}

// 文件名：短横线分隔
// user-service.ts
// attribution-tracker.tsx
// api-response.d.ts
```

#### 函数规范
```typescript
/**
 * 计算订单总金额
 * 
 * @param items - 订单项目列表
 * @param discount - 折扣金额（可选）
 * @returns 订单总金额（单位：分）
 */
function calculateOrderTotal(
  items: OrderItem[],
  discount?: number
): number {
  // 验证输入参数
  if (!items || items.length === 0) {
    return 0;
  }
  
  // 计算商品总价
  const subtotal = items.reduce((sum, item) => {
    return sum + item.price * item.quantity;
  }, 0);
  
  // 应用折扣
  const finalAmount = discount 
    ? Math.max(0, subtotal - discount)
    : subtotal;
  
  return finalAmount;
}
```

#### 异步处理
```typescript
// ✅ 推荐：使用 async/await
async function fetchUserData(userId: string): Promise<User> {
  try {
    // 从数据库获取用户信息
    const user = await db.users.findUnique({
      where: { uuid: userId }
    });
    
    if (!user) {
      throw new Error(`用户不存在: ${userId}`);
    }
    
    return user;
  } catch (error) {
    console.error("获取用户数据失败:", error);
    throw error;
  }
}

// ❌ 避免：回调地狱
getUserData(userId, (err, user) => {
  if (err) {
    handleError(err);
  } else {
    getOrders(user.id, (err, orders) => {
      // 嵌套回调...
    });
  }
});
```

### React组件规范

#### 函数组件
```tsx
/**
 * 用户卡片组件
 * 
 * 功能：显示用户基本信息和操作按钮
 * 使用场景：用户列表、用户详情页
 */
interface UserCardProps {
  user: User;                    // 用户信息
  onEdit?: (id: string) => void; // 编辑回调
  onDelete?: (id: string) => void; // 删除回调
  className?: string;            // 自定义样式类
}

export function UserCard({ 
  user, 
  onEdit, 
  onDelete,
  className 
}: UserCardProps) {
  // 状态管理
  const [isLoading, setIsLoading] = useState(false);
  
  // 副作用
  useEffect(() => {
    // 组件挂载时的逻辑
    console.log(`用户卡片已加载: ${user.id}`);
    
    // 清理函数
    return () => {
      console.log(`用户卡片已卸载: ${user.id}`);
    };
  }, [user.id]);
  
  // 事件处理
  const handleEdit = useCallback(() => {
    if (onEdit) {
      setIsLoading(true);
      onEdit(user.id);
    }
  }, [user.id, onEdit]);
  
  // 渲染
  return (
    <div className={cn("user-card", className)}>
      <Avatar src={user.avatar} alt={user.name} />
      <h3>{user.name}</h3>
      <p>{user.email}</p>
      
      {/* 条件渲染 */}
      {onEdit && (
        <Button 
          onClick={handleEdit}
          disabled={isLoading}
        >
          编辑
        </Button>
      )}
    </div>
  );
}
```

#### Hooks使用规范
```typescript
// 自定义Hook：use开头
function useUserData(userId: string) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);
  
  useEffect(() => {
    // 获取用户数据
    fetchUser();
    
    async function fetchUser() {
      try {
        setLoading(true);
        const data = await getUserById(userId);
        setUser(data);
      } catch (err) {
        setError(err as Error);
      } finally {
        setLoading(false);
      }
    }
  }, [userId]);
  
  return { user, loading, error };
}
```

### CSS/Tailwind规范

#### 类名顺序
```tsx
// 推荐的Tailwind类名顺序
<div className="
  {/* 布局 */}
  flex flex-col items-center justify-between
  
  {/* 间距 */}
  p-4 m-2 gap-4
  
  {/* 尺寸 */}
  w-full h-64 max-w-lg
  
  {/* 背景和边框 */}
  bg-white border border-gray-200 rounded-lg
  
  {/* 文字 */}
  text-gray-800 text-sm font-medium
  
  {/* 效果 */}
  shadow-md hover:shadow-lg
  
  {/* 过渡 */}
  transition-all duration-200
  
  {/* 响应式 */}
  md:flex-row lg:p-8
">
```

## 💬 注释规范

### 文件头注释
```typescript
/**
 * 用户归因服务
 * 
 * 功能：处理用户来源追踪、设备识别、地理定位
 * 作者：开发团队
 * 创建日期：2024-01-15
 * 最后修改：2024-08-17
 * 
 * 依赖：
 * - ua-parser-js: 解析User Agent
 * - geoip-lite: IP地理定位
 * 
 * 注意事项：
 * - Cookie有效期30天
 * - 本地开发环境IP显示为localhost
 */
```

### 函数注释
```typescript
/**
 * 解析UTM参数
 * 
 * 问题：需要从URL中提取营销追踪参数
 * 解决方案：解析查询字符串，提取标准UTM参数
 * 
 * @param url - 完整的URL字符串
 * @returns UTM参数对象，包含source、medium、campaign等
 * 
 * @example
 * const utm = parseUTMParams("https://example.com?utm_source=google&utm_medium=cpc");
 * // 返回: { source: "google", medium: "cpc" }
 */
function parseUTMParams(url: string): UTMParams {
  // 实现代码...
}
```

### 行内注释
```typescript
// ✅ 好的注释：解释为什么
// 使用30天作为归因窗口期，这是行业标准
const ATTRIBUTION_WINDOW = 30 * 24 * 60 * 60 * 1000;

// ❌ 不好的注释：解释是什么（代码本身已经很清楚）
// 设置count为0
let count = 0;

// ✅ 复杂逻辑注释
// 计算转化率时需要处理除零的情况
// 如果没有用户，返回0而不是NaN
const conversionRate = totalUsers > 0 
  ? (paidUsers / totalUsers) * 100 
  : 0;
```

### TODO注释
```typescript
// TODO: 添加缓存机制提高性能
// TODO(张三): 2024-09-01 前完成邮件通知功能
// FIXME: 修复在Safari浏览器下的兼容性问题
// HACK: 临时解决方案，等待上游库修复
// NOTE: 这里使用了第三方API，需要配置API密钥
```

## 📝 Git提交规范

### 提交消息格式
```
<type>(<scope>): <subject>

<body>

<footer>
```

### Type类型
```bash
feat:     新功能
fix:      修复bug
docs:     文档更新
style:    代码格式（不影响代码运行）
refactor: 重构（既不是新功能也不是修复bug）
perf:     性能优化
test:     测试相关
chore:    构建过程或辅助工具的变动
```

### 示例
```bash
# ✅ 好的提交消息
git commit -m "feat(auth): 添加Google OAuth登录功能"
git commit -m "fix(payment): 修复Stripe支付回调失败问题"
git commit -m "docs: 更新API文档和部署指南"
git commit -m "perf(db): 优化用户查询，添加索引"

# ❌ 不好的提交消息
git commit -m "修改代码"
git commit -m "fix"
git commit -m "更新"
```

### 详细提交示例
```
feat(attribution): 实现用户归因追踪系统

- 添加Cookie染色机制，30天持久化追踪
- 实现UTM参数解析和存储
- 添加设备类型检测（PC/移动/平板）
- 集成IP地理定位服务

相关Issue: #123
```

## 🏗 项目结构规范

### 文件组织
```
src/
├── app/          # 页面和路由
├── components/   # 可复用组件
│   ├── ui/      # 基础UI组件
│   └── blocks/  # 业务组件
├── services/    # 业务逻辑
├── lib/         # 工具函数
├── hooks/       # 自定义Hooks
├── types/       # 类型定义
└── styles/      # 全局样式
```

### 导入顺序
```typescript
// 1. React相关
import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';

// 2. 第三方库
import { format } from 'date-fns';
import axios from 'axios';

// 3. 内部组件
import { Button } from '@/components/ui/button';
import { UserCard } from '@/components/user-card';

// 4. 服务和工具
import { getUserData } from '@/services/user';
import { formatCurrency } from '@/lib/utils';

// 5. 类型定义
import type { User, Order } from '@/types';

// 6. 样式
import styles from './styles.module.css';
```

## 🔒 安全规范

### 敏感信息处理
```typescript
// ❌ 错误：硬编码敏感信息
const API_KEY = "sk-xxxxxxxxxxxx";  // 示例，切勿使用真实密钥

// ✅ 正确：使用环境变量
const API_KEY = process.env.OPENAI_API_KEY;

// ❌ 错误：在日志中输出敏感信息
console.log("用户密码:", password);

// ✅ 正确：脱敏处理
console.log("用户登录:", { email: user.email, id: user.id });
```

### 输入验证
```typescript
// 始终验证用户输入
function createUser(data: unknown) {
  // 使用zod或其他验证库
  const schema = z.object({
    email: z.string().email(),
    name: z.string().min(2).max(50),
    age: z.number().min(0).max(120)
  });
  
  const validatedData = schema.parse(data);
  // 继续处理...
}
```

## 📊 性能规范

### 组件优化
```typescript
// 使用memo避免不必要的重渲染
export const ExpensiveComponent = React.memo(({ data }) => {
  // 组件逻辑
});

// 使用useMemo缓存计算结果
const expensiveValue = useMemo(() => {
  return calculateExpensiveValue(data);
}, [data]);

// 使用useCallback缓存函数
const handleClick = useCallback(() => {
  doSomething(id);
}, [id]);
```

### 图片优化
```tsx
// 使用Next.js Image组件
import Image from 'next/image';

<Image
  src="/avatar.jpg"
  alt="用户头像"
  width={100}
  height={100}
  loading="lazy"
  placeholder="blur"
/>
```

## ✅ 代码审查清单

### 提交前检查
- [ ] 代码已格式化（prettier）
- [ ] 通过ESLint检查
- [ ] 通过TypeScript类型检查
- [ ] 添加了必要的中文注释
- [ ] 没有console.log调试代码
- [ ] 没有硬编码的敏感信息
- [ ] 测试用例通过

### 审查要点
- [ ] 代码逻辑清晰易懂
- [ ] 命名规范符合约定
- [ ] 错误处理完善
- [ ] 性能考虑充分
- [ ] 安全性检查通过
- [ ] 文档更新同步

## 🛠 开发工具配置

### VSCode推荐插件
```json
{
  "recommendations": [
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "bradlc.vscode-tailwindcss",
    "prisma.prisma",
    "GitHub.copilot"
  ]
}
```

### Prettier配置
```json
{
  "semi": true,
  "singleQuote": false,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 80,
  "bracketSpacing": true
}
```

### ESLint配置
```json
{
  "extends": [
    "next/core-web-vitals",
    "plugin:@typescript-eslint/recommended"
  ],
  "rules": {
    "no-console": "warn",
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/no-explicit-any": "warn"
  }
}
```

## 📚 参考资源

- [TypeScript官方文档](https://www.typescriptlang.org/docs/)
- [React最佳实践](https://react.dev/learn)
- [Next.js文档](https://nextjs.org/docs)
- [Tailwind CSS文档](https://tailwindcss.com/docs)
- [Clean Code原则](https://github.com/ryanmcdermott/clean-code-javascript)

---

*文档版本：v1.0*  
*更新日期：2025-08-17*  
*适用项目：AI通用生成器 v2.6.0+*